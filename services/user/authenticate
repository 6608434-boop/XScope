#!/usr/bin/env python
# -*- coding: utf-8 -*-

"""
================================================================================
–§–ê–ô–õ: services/user/authenticate.py
–ù–ê–ó–ù–ê–ß–ï–ù–ò–ï: –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
–ê–í–¢–û–†: Oliver Vance
–î–ê–¢–ê: 2026-02-14

–û–ü–ò–°–ê–ù–ò–ï:
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –≤—Ö–æ–¥–µ.

–ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï:
    from services.user.authenticate import authenticate_user

    user = authenticate_user('username', 'password')
    if user:
        session['user_id'] = user['id']

–§–£–ù–ö–¶–ò–ò:
    authenticate_user(username, password) - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–∏–Ω–∞/–ø–∞—Ä–æ–ª—è

–ò–°–¢–û–†–ò–Ø –ò–ó–ú–ï–ù–ï–ù–ò–ô:
    2026-02-14 - Oliver - —Å–æ–∑–¥–∞–Ω–∏–µ
================================================================================
"""

from typing import Optional, Dict, Any

from models.user import User
from utils.security import check_password

import logging

logger = logging.getLogger(__name__)


def authenticate_user(username: str, password: str) -> Optional[Dict[str, Any]]:
    """
    –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –∏–º–µ–Ω–∏ –∏ –ø–∞—Ä–æ–ª—é.

    Args:
        username: –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        password: –ü–∞—Ä–æ–ª—å

    Returns:
        Optional[Dict]: –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ, –∏–Ω–∞—á–µ None
    """
    logger.info(f"üîê –ü–æ–ø—ã—Ç–∫–∞ –≤—Ö–æ–¥–∞: {username}")

    # 1. –ò—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î
    user = User.get_by_username(username)

    if not user:
        logger.warning(f"‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {username} –Ω–µ –Ω–∞–π–¥–µ–Ω")
        return None

    # 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ä–æ–ª—å
    if not check_password(user['password_hash'], password):
        logger.warning(f"‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å –¥–ª—è {username}")
        return None

    # 3. –£–±–∏—Ä–∞–µ–º —Ö–µ—à –ø–∞—Ä–æ–ª—è –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    user_data = {
        'id': user['id'],
        'username': user['username'],
        'twofa_enabled': user['twofa_enabled'],
        'created_at': user['created_at']
    }

    logger.info(f"‚úÖ –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥: {username} (ID: {user['id']})")
    return user_data


def authenticate_with_2fa(username: str, password: str, twofa_code: str) -> Optional[Dict[str, Any]]:
    """
    –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —Å –¥–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π.

    Args:
        username: –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        password: –ü–∞—Ä–æ–ª—å
        twofa_code: –ö–æ–¥ –∏–∑ Google Authenticator

    Returns:
        Optional[Dict]: –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å–ª–∏ –≤—Å—ë –æ–∫
    """
    # TODO: —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è 2FA
    logger.warning("2FA –µ—â—ë –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ")
    return None