#!/usr/bin/env python
# -*- coding: utf-8 -*-

"""
================================================================================
–§–ê–ô–õ: services/chat/load.py
–ù–ê–ó–ù–ê–ß–ï–ù–ò–ï: –ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–∞ —Å –∏—Å—Ç–æ—Ä–∏–µ–π
–ê–í–¢–û–†: Oliver Vance
–î–ê–¢–ê: 2026-02-14

–û–ü–ò–°–ê–ù–ò–ï:
    –ó–∞–≥—Ä—É–∂–∞–µ—Ç —á–∞—Ç –∏ –µ–≥–æ –∏—Å—Ç–æ—Ä–∏—é —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –¥–æ—Å—Ç—É–ø–∞.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.

–ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï:
    from services.chat.load import load_chat

    chat_data = load_chat(user_id=1, chat_id=123)

–§–£–ù–ö–¶–ò–ò:
    load_chat(user_id, chat_id) - –∑–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–∞ —Å –∏—Å—Ç–æ—Ä–∏–µ–π

–ò–°–¢–û–†–ò–Ø –ò–ó–ú–ï–ù–ï–ù–ò–ô:
    2026-02-14 - Oliver - —Å–æ–∑–¥–∞–Ω–∏–µ
================================================================================
"""

from typing import Dict, Any, Optional, Tuple

from models.chat import Chat
from models.message import Message
from models.profile import BotProfile

import logging

logger = logging.getLogger(__name__)


def load_chat(user_id: int, chat_id: int) -> Dict[str, Any]:
    """
    –ó–∞–≥—Ä—É–∂–∞–µ—Ç —á–∞—Ç –∏ –µ–≥–æ –∏—Å—Ç–æ—Ä–∏—é —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –¥–æ—Å—Ç—É–ø–∞.

    Args:
        user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        chat_id: ID —á–∞—Ç–∞

    Returns:
        Dict: –î–∞–Ω–Ω—ã–µ —á–∞—Ç–∞:
            - chat: –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —á–∞—Ç–µ
            - history: –∏—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
            - profile: –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è (–µ—Å–ª–∏ –µ—Å—Ç—å)

    Raises:
        ValueError: –ï—Å–ª–∏ —á–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω
        ValueError: –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤–ª–∞–¥–µ–ª–µ—Ü
    """
    logger.info(f"üìÇ –ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–∞ {chat_id} –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")

    # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —á–∞—Ç–∞
    chat = Chat.get_by_id(chat_id)
    if not chat:
        error_msg = f"–ß–∞—Ç {chat_id} –Ω–µ –Ω–∞–π–¥–µ–Ω"
        logger.error(f"‚ùå {error_msg}")
        raise ValueError(error_msg)

    # 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –≤–ª–∞–¥–µ–ª—å—Ü–∞
    if chat['user_id'] != user_id:
        error_msg = f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –≤–ª–∞–¥–µ–ª—å—Ü–µ–º —á–∞—Ç–∞ {chat_id}"
        logger.error(f"‚ùå {error_msg}")
        raise ValueError(error_msg)

    # 3. –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π
    history = Message.get_chat_history(chat_id)
    logger.debug(f"üìú –ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(history)} —Å–æ–æ–±—â–µ–Ω–∏–π")

    # 4. –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è (–µ—Å–ª–∏ –µ—Å—Ç—å)
    profile = None
    if chat.get('bot_profile_id'):
        profile = BotProfile.get_by_id(chat['bot_profile_id'])
        if profile:
            logger.debug(f"ü§ñ –ü—Ä–æ—Ñ–∏–ª—å –±–æ—Ç–∞: {profile['bot_name']}")

    # 5. –§–æ—Ä–º–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    result = {
        'chat': {
            'id': chat['id'],
            'title': chat['title'],
            'created_at': chat['created_at'],
            'updated_at': chat['updated_at']
        },
        'history': history,
        'profile': profile
    }

    logger.info(f"‚úÖ –ß–∞—Ç {chat_id} —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω")
    return result


def load_chat_with_context(user_id: int, chat_id: int) -> Tuple[Dict[str, Any], str]:
    """
    –ó–∞–≥—Ä—É–∂–∞–µ—Ç —á–∞—Ç –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç (–µ—Å–ª–∏ –µ—Å—Ç—å).

    Args:
        user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        chat_id: ID —á–∞—Ç–∞

    Returns:
        Tuple: (–¥–∞–Ω–Ω—ã–µ —á–∞—Ç–∞, —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç)
    """
    chat_data = load_chat(user_id, chat_id)

    system_prompt = ""
    if chat_data.get('profile'):
        # TODO: –¥–æ–±–∞–≤–∏—Ç—å —Å–±–æ—Ä–∫—É –ø—Ä–æ–º–ø—Ç–∞ —Å –ø—Ä–∞–≤–∏–ª–∞–º–∏
        system_prompt = chat_data['profile']['system_prompt']

    return chat_data, system_prompt