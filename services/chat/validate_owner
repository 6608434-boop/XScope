#!/usr/bin/env python
# -*- coding: utf-8 -*-

"""
================================================================================
ФАЙЛ: services/chat/validate_owner.py
НАЗНАЧЕНИЕ: Проверка владельца чата
АВТОР: Oliver Vance
ДАТА: 2026-02-14

ОПИСАНИЕ:
    Проверяет, является ли пользователь владельцем чата.
    Используется в декораторах и middleware.

ИСПОЛЬЗОВАНИЕ:
    from services.chat.validate_owner import validate_chat_owner

    if validate_chat_owner(user_id=1, chat_id=123):
        print("Пользователь - владелец")

ФУНКЦИИ:
    validate_chat_owner(user_id, chat_id) - проверка владельца
    get_chat_owner(chat_id) - получение ID владельца

ИСТОРИЯ ИЗМЕНЕНИЙ:
    2026-02-14 - Oliver - создание
================================================================================
"""

from typing import Optional

from models.chat import Chat

import logging

logger = logging.getLogger(__name__)


def validate_chat_owner(user_id: int, chat_id: int) -> bool:
    """
    Проверяет, является ли пользователь владельцем чата.

    Args:
        user_id: ID пользователя
        chat_id: ID чата

    Returns:
        bool: True если пользователь - владелец

    Пример:
        if not validate_chat_owner(user_id, chat_id):
            raise ValueError("Access denied")
    """
    # Получаем чат
    chat = Chat.get_by_id(chat_id)

    if not chat:
        logger.debug(f"Чат {chat_id} не найден при проверке владельца")
        return False

    is_owner = chat['user_id'] == user_id

    if is_owner:
        logger.debug(f"✅ Пользователь {user_id} - владелец чата {chat_id}")
    else:
        logger.warning(f"❌ Пользователь {user_id} не является владельцем чата {chat_id}")

    return is_owner


def get_chat_owner(chat_id: int) -> Optional[int]:
    """
    Возвращает ID владельца чата.

    Args:
        chat_id: ID чата

    Returns:
        Optional[int]: ID владельца или None если чат не найден
    """
    chat = Chat.get_by_id(chat_id)

    if not chat:
        logger.debug(f"Чат {chat_id} не найден при получении владельца")
        return None

    return chat['user_id']


def ensure_chat_owner(user_id: int, chat_id: int) -> None:
    """
    Проверяет владельца и кидает исключение если проверка не пройдена.

    Args:
        user_id: ID пользователя
        chat_id: ID чата

    Raises:
        ValueError: Если чат не найден
        PermissionError: Если пользователь не владелец
    """
    chat = Chat.get_by_id(chat_id)

    if not chat:
        error_msg = f"Чат {chat_id} не найден"
        logger.error(f"❌ {error_msg}")
        raise ValueError(error_msg)

    if chat['user_id'] != user_id:
        error_msg = f"Доступ запрещён: пользователь {user_id} не владелец чата {chat_id}"
        logger.error(f"❌ {error_msg}")
        raise PermissionError(error_msg)

    logger.debug(f"✅ Проверка владельца для чата {chat_id} пройдена")