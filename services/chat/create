#!/usr/bin/env python
# -*- coding: utf-8 -*-

"""
================================================================================
–§–ê–ô–õ: services/chat/create.py
–ù–ê–ó–ù–ê–ß–ï–ù–ò–ï: –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —á–∞—Ç–∞
–ê–í–¢–û–†: Oliver Vance
–î–ê–¢–ê: 2026-02-14

–û–ü–ò–°–ê–ù–ò–ï:
    –°–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–π —á–∞—Ç —Å –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏:
    - –°—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    - –°—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø—Ä–æ—Ñ–∏–ª—å (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω)
    - –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è

–ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï:
    from services.chat.create import create_chat

    chat_id = create_chat(
        user_id=1,
        title="–ú–æ–π —á–∞—Ç",
        bot_profile_id="will"
    )

–§–£–ù–ö–¶–ò–ò:
    create_chat(user_id, title, bot_profile_id) - —Å–æ–∑–¥–∞–Ω–∏–µ —á–∞—Ç–∞
    _validate_bot_profile(bot_profile_id) - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è

–ò–°–¢–û–†–ò–Ø –ò–ó–ú–ï–ù–ï–ù–ò–ô:
    2026-02-14 - Oliver - —Å–æ–∑–¥–∞–Ω–∏–µ
================================================================================
"""

from typing import Optional

from models.chat import Chat
from models.user import User
from models.profile import BotProfile
from utils.validators import validate_chat_title, sanitize_chat_title

import logging

logger = logging.getLogger(__name__)


def _validate_bot_profile(bot_profile_id: Optional[str]) -> Optional[int]:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –µ–≥–æ ID.

    Args:
        bot_profile_id: –°—Ç—Ä–æ–∫–æ–≤—ã–π ID –ø—Ä–æ—Ñ–∏–ª—è ('will', 'oliver', ...)

    Returns:
        Optional[int]: –ß–∏—Å–ª–æ–≤–æ–π ID –ø—Ä–æ—Ñ–∏–ª—è –∏–ª–∏ None

    Raises:
        ValueError: –ï—Å–ª–∏ –ø—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω
    """
    if not bot_profile_id:
        return None

    profile = BotProfile.get_by_bot_id(bot_profile_id)
    if not profile:
        error_msg = f"–ü—Ä–æ—Ñ–∏–ª—å '{bot_profile_id}' –Ω–µ –Ω–∞–π–¥–µ–Ω"
        logger.error(f"‚ùå {error_msg}")
        raise ValueError(error_msg)

    logger.debug(f"‚úÖ –ù–∞–π–¥–µ–Ω –ø—Ä–æ—Ñ–∏–ª—å {bot_profile_id} (ID: {profile['id']})")
    return profile['id']


def create_chat(user_id: int, title: str, bot_profile_id: Optional[str] = None) -> int:
    """
    –°–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–π —á–∞—Ç.

    Args:
        user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        title: –ù–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞
        bot_profile_id: –°—Ç—Ä–æ–∫–æ–≤—ã–π ID –ø—Ä–æ—Ñ–∏–ª—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

    Returns:
        int: ID —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ —á–∞—Ç–∞

    Raises:
        ValueError: –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω
        ValueError: –ï—Å–ª–∏ –ø—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω
        ValueError: –ï—Å–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
    """
    logger.info(f"üöÄ –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —á–∞—Ç–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")

    # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user = User.get_by_id(user_id)
    if not user:
        error_msg = f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –Ω–µ –Ω–∞–π–¥–µ–Ω"
        logger.error(f"‚ùå {error_msg}")
        raise ValueError(error_msg)

    # 2. –í–∞–ª–∏–¥–∏—Ä—É–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ
    try:
        validate_chat_title(title)
    except ValueError as e:
        logger.error(f"‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞: {e}")
        raise

    # 3. –û—á–∏—â–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –æ—Ç –ª–∏—à–Ω–∏—Ö –ø—Ä–æ–±–µ–ª–æ–≤
    clean_title = sanitize_chat_title(title)
    if clean_title != title:
        logger.debug(f"–ù–∞–∑–≤–∞–Ω–∏–µ –æ—á–∏—â–µ–Ω–æ: '{title}' ‚Üí '{clean_title}'")

    # 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω)
    db_profile_id = _validate_bot_profile(bot_profile_id)

    # 5. –°–æ–∑–¥–∞—ë–º —á–∞—Ç
    chat_id = Chat.create(user_id, clean_title, db_profile_id)

    logger.info(f"‚úÖ –ß–∞—Ç {chat_id} —Å–æ–∑–¥–∞–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
    return chat_id