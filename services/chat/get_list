#!/usr/bin/env python
# -*- coding: utf-8 -*-

"""
================================================================================
–§–ê–ô–õ: services/chat/get_list.py
–ù–ê–ó–ù–ê–ß–ï–ù–ò–ï: –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
–ê–í–¢–û–†: Oliver Vance
–î–ê–¢–ê: 2026-02-14

–û–ü–ò–°–ê–ù–ò–ï:
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Å–µ —á–∞—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º –¥–ª—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞.
    –î–æ–±–∞–≤–ª—è–µ—Ç –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.

–ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï:
    from services.chat.get_list import get_user_chats

    chats = get_user_chats(user_id=1)

–§–£–ù–ö–¶–ò–ò:
    get_user_chats(user_id) - —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ —Å –¥–∞—Ç–∞–º–∏
    _format_chat_date(dt) - —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã –¥–ª—è —Å–ø–∏—Å–∫–∞

–ò–°–¢–û–†–ò–Ø –ò–ó–ú–ï–ù–ï–ù–ò–ô:
    2026-02-14 - Oliver - —Å–æ–∑–¥–∞–Ω–∏–µ
================================================================================
"""

from typing import List, Dict, Any
from datetime import datetime

from models.chat import Chat
from utils.formatters import format_for_chat_list

import logging

logger = logging.getLogger(__name__)


def _format_chat_date(last_message_at) -> str:
    """
    –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –¥–∞—Ç—É –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —Å–ø–∏—Å–∫–µ —á–∞—Ç–æ–≤.

    Args:
        last_message_at: –î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è (datetime –∏–ª–∏ None)

    Returns:
        str: –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–∞—Ç–∞
    """
    if not last_message_at:
        return "–Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π"

    return format_for_chat_list(last_message_at)


def get_user_chats(user_id: int) -> List[Dict[str, Any]]:
    """
    –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ —á–∞—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –¥–∞—Ç–∞–º–∏.

    Args:
        user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

    Returns:
        List[Dict]: –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ —Å –ø–æ–ª—è–º–∏:
            - id: ID —á–∞—Ç–∞
            - title: –Ω–∞–∑–≤–∞–Ω–∏–µ
            - avatar: —ç–º–æ–¥–∑–∏ –ø—Ä–æ—Ñ–∏–ª—è
            - date: –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–∞—Ç–∞
    """
    logger.info(f"üìã –ó–∞–ø—Ä–æ—Å —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")

    # –ü–æ–ª—É—á–∞–µ–º —Å—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –º–æ–¥–µ–ª–∏
    raw_chats = Chat.get_user_chats(user_id)

    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–ª—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
    formatted_chats = []
    for chat in raw_chats:
        formatted_chats.append({
            'id': chat['id'],
            'title': chat['title'],
            'avatar': chat['avatar'],
            'date': _format_chat_date(chat.get('last_message_at'))
        })

    logger.debug(f"üìä –ù–∞–π–¥–µ–Ω–æ {len(formatted_chats)} —á–∞—Ç–æ–≤")
    return formatted_chats