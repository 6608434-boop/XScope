#!/usr/bin/env python
# -*- coding: utf-8 -*-

"""
================================================================================
–§–ê–ô–õ: services/ai/build_prompt.py
–ù–ê–ó–ù–ê–ß–ï–ù–ò–ï: –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è AI
–ê–í–¢–û–†: Oliver Vance
–î–ê–¢–ê: 2026-02-14

–û–ü–ò–°–ê–ù–ò–ï:
    –°–æ–±–∏—Ä–∞–µ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è AI –Ω–∞ –æ—Å–Ω–æ–≤–µ:
    - –ë–∞–∑–æ–≤–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ –ø—Ä–æ—Ñ–∏–ª—è
    - –ü—Ä–∞–≤–∏–ª –¥–ª—è —ç—Ç–æ–≥–æ —á–∞—Ç–∞
    - –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π

–ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï:
    from services.ai.build_prompt import build_system_prompt

    prompt = build_system_prompt(profile_id=1)

–§–£–ù–ö–¶–ò–ò:
    build_system_prompt(profile_id) - —Å–±–æ—Ä–∫–∞ –ø–æ–ª–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞
    _add_rules_to_prompt(base_prompt, profile_id) - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª

–ò–°–¢–û–†–ò–Ø –ò–ó–ú–ï–ù–ï–ù–ò–ô:
    2026-02-14 - Oliver - —Å–æ–∑–¥–∞–Ω–∏–µ
================================================================================
"""

from typing import Optional

from models.profile import BotProfile
from models.rule import ProfileRule

import logging

logger = logging.getLogger(__name__)


def _add_rules_to_prompt(base_prompt: str, profile_id: int) -> str:
    """
    –î–æ–±–∞–≤–ª—è–µ—Ç –ø—Ä–∞–≤–∏–ª–∞ –ø—Ä–æ—Ñ–∏–ª—è –∫ –ø—Ä–æ–º–ø—Ç—É.

    Args:
        base_prompt: –ë–∞–∑–æ–≤—ã–π –ø—Ä–æ–º–ø—Ç
        profile_id: ID –ø—Ä–æ—Ñ–∏–ª—è

    Returns:
        str: –ü—Ä–æ–º–ø—Ç —Å –ø—Ä–∞–≤–∏–ª–∞–º–∏
    """
    rules_text = ProfileRule.format_for_prompt(profile_id)

    if rules_text:
        logger.debug(f"üìã –î–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–∞–≤–∏–ª–∞ –∫ –ø—Ä–æ–º–ø—Ç—É (–ø—Ä–æ—Ñ–∏–ª—å {profile_id})")
        return base_prompt + rules_text

    return base_prompt


def build_system_prompt(profile_id: Optional[int] = None) -> str:
    """
    –°–æ–±–∏—Ä–∞–µ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è AI.

    Args:
        profile_id: ID –ø—Ä–æ—Ñ–∏–ª—è (–µ—Å–ª–∏ None - –ø—É—Å—Ç–æ–π –ø—Ä–æ–º–ø—Ç)

    Returns:
        str: –ü–æ–ª–Ω—ã–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç
    """
    logger.info(f"üî® –°–±–æ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è –ø—Ä–æ—Ñ–∏–ª—è {profile_id}")

    if not profile_id:
        logger.debug("–ü—Ä–æ—Ñ–∏–ª—å –Ω–µ —É–∫–∞–∑–∞–Ω, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π –ø—Ä–æ–º–ø—Ç")
        return ""

    # 1. –ü–æ–ª—É—á–∞–µ–º –±–∞–∑–æ–≤—ã–π –ø—Ä–æ–º–ø—Ç –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è
    profile = BotProfile.get_with_prompt(profile_id)
    if not profile:
        logger.warning(f"‚ö†Ô∏è –ü—Ä–æ—Ñ–∏–ª—å {profile_id} –Ω–µ –Ω–∞–π–¥–µ–Ω")
        return ""

    base_prompt = profile['system_prompt']

    # 2. –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∏–ª–∞
    full_prompt = _add_rules_to_prompt(base_prompt, profile_id)

    logger.info(f"‚úÖ –ü—Ä–æ–º–ø—Ç —Å–æ–±—Ä–∞–Ω (–¥–ª–∏–Ω–∞: {len(full_prompt)} —Å–∏–º–≤–æ–ª–æ–≤)")
    return full_prompt


def build_messages_for_ai(
    history: list,
    current_message: str,
    system_prompt: Optional[str] = None
) -> list:
    """
    –°—Ç—Ä–æ–∏—Ç —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ AI API.

    Args:
        history: –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π [(role, content), ...]
        current_message: –¢–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        system_prompt: –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

    Returns:
        list: –°–æ–æ–±—â–µ–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ –¥–ª—è API
    """
    messages = []

    # –î–æ–±–∞–≤–ª—è–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç (–µ—Å–ª–∏ –µ—Å—Ç—å)
    if system_prompt:
        messages.append({
            "role": "system",
            "content": system_prompt
        })

    # –î–æ–±–∞–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é
    for role, content in history[-10:]:  # –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å–æ–æ–±—â–µ–Ω–∏–π
        messages.append({
            "role": role,
            "content": content
        })

    # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    messages.append({
        "role": "user",
        "content": current_message
    })

    logger.debug(f"üì¶ –ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–æ {len(messages)} —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è AI")
    return messages