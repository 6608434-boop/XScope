#!/usr/bin/env python
# -*- coding: utf-8 -*-

"""
================================================================================
–§–ê–ô–õ: services/ai/call_deepseek.py
–ù–ê–ó–ù–ê–ß–ï–ù–ò–ï: –í—ã–∑–æ–≤ DeepSeek API
–ê–í–¢–û–†: Oliver Vance
–î–ê–¢–ê: 2026-02-14

–û–ü–ò–°–ê–ù–ò–ï:
    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ DeepSeek API –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç–≤–µ—Ç.
    –°–æ–¥–µ—Ä–∂–∏—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏.

–ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï:
    from services.ai.call_deepseek import call_deepseek

    response = call_deepseek(history, message, system_prompt)

–§–£–ù–ö–¶–ò–ò:
    call_deepseek(history, message, system_prompt) - –≤—ã–∑–æ–≤ API
    _make_api_request(messages) - –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ –∑–∞–ø—Ä–æ—Å –∫ API

–ò–°–¢–û–†–ò–Ø –ò–ó–ú–ï–ù–ï–ù–ò–ô:
    2026-02-14 - Oliver - —Å–æ–∑–¥–∞–Ω–∏–µ
================================================================================
"""

import time
import logging
from typing import List, Tuple, Optional
import requests

from config.api_keys import APIConfig
from services.ai.build_prompt import build_messages_for_ai

logger = logging.getLogger(__name__)


class DeepSeekAPIError(Exception):
    """–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ DeepSeek API"""
    pass


def _make_api_request(messages: List[dict], retry_count: int = 3) -> Optional[str]:
    """
    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ DeepSeek API —Å –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏.

    Args:
        messages: –°–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
        retry_count: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫

    Returns:
        Optional[str]: –¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞ –∏–ª–∏ None

    Raises:
        DeepSeekAPIError: –ï—Å–ª–∏ API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ—Å–ª–µ –≤—Å–µ—Ö –ø–æ–ø—ã—Ç–æ–∫
    """
    if not APIConfig.check_deepseek():
        logger.error("‚ùå DeepSeek API –∫–ª—é—á –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω")
        return "DeepSeek API –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –¥–æ–±–∞–≤—å—Ç–µ DEEPSEEK_API_KEY –≤ .env"

    headers = {
        "Authorization": f"Bearer {APIConfig.DEEPSEEK_API_KEY}",
        "Content-Type": "application/json"
    }

    data = {
        "model": APIConfig.DEEPSEEK_MODEL,
        "messages": messages,
        "temperature": 0.7,
        "max_tokens": APIConfig.DEEPSEEK_MAX_TOKENS
    }

    for attempt in range(retry_count):
        try:
            logger.debug(f"üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ DeepSeek (–ø–æ–ø—ã—Ç–∫–∞ {attempt + 1})")

            response = requests.post(
                f"{APIConfig.DEEPSEEK_API_URL}/chat/completions",
                headers=headers,
                json=data,
                timeout=APIConfig.DEEPSEEK_TIMEOUT
            )

            if response.status_code == 200:
                result = response.json()
                reply = result['choices'][0]['message']['content']
                logger.info(f"‚úÖ –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç DeepSeek ({len(reply)} —Å–∏–º–≤–æ–ª–æ–≤)")
                return reply

            elif response.status_code == 401:
                logger.error("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π API –∫–ª—é—á DeepSeek")
                return "–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ DeepSeek API. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ API –∫–ª—é—á."

            elif response.status_code == 429:
                logger.warning(f"‚ö†Ô∏è –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤, –ø–æ–ø—ã—Ç–∫–∞ {attempt + 1}")
                if attempt < retry_count - 1:
                    time.sleep(2 ** attempt)  # —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞
                    continue

            else:
                logger.error(f"‚ùå –û—à–∏–±–∫–∞ DeepSeek API: {response.status_code} - {response.text}")

        except requests.exceptions.Timeout:
            logger.warning(f"‚è±Ô∏è –¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞, –ø–æ–ø—ã—Ç–∫–∞ {attempt + 1}")
            if attempt < retry_count - 1:
                time.sleep(1)
                continue

        except requests.exceptions.ConnectionError:
            logger.warning(f"üîå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è, –ø–æ–ø—ã—Ç–∫–∞ {attempt + 1}")
            if attempt < retry_count - 1:
                time.sleep(2)
                continue

        except Exception as e:
            logger.error(f"‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: {e}")
            if attempt < retry_count - 1:
                time.sleep(1)
                continue

    error_msg = "DeepSeek API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ—Å–ª–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–æ–ø—ã—Ç–æ–∫"
    logger.error(f"‚ùå {error_msg}")
    return f"–ò–∑–≤–∏–Ω–∏—Ç–µ, —Å–µ—Ä–≤–∏—Å –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."


def call_deepseek(
    history: List[Tuple[str, str]],
    message: str,
    system_prompt: Optional[str] = None
) -> str:
    """
    –í—ã–∑—ã–≤–∞–µ—Ç DeepSeek API –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç–≤–µ—Ç.

    Args:
        history: –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π [(role, content), ...]
        message: –¢–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        system_prompt: –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

    Returns:
        str: –û—Ç–≤–µ—Ç –æ—Ç AI
    """
    logger.info("ü§ñ –í—ã–∑–æ–≤ DeepSeek API")

    # 1. –°—Ç—Ä–æ–∏–º —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
    messages = build_messages_for_ai(history, message, system_prompt)

    # 2. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
    reply = _make_api_request(messages)

    if reply is None:
        reply = "–ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç AI. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."

    return reply


def call_deepseek_stream(
    history: List[Tuple[str, str]],
    message: str,
    system_prompt: Optional[str] = None
):
    """
    –°—Ç—Ä–∏–º–∏–Ω–≥–æ–≤–∞—è –≤–µ—Ä—Å–∏—è –≤—ã–∑–æ–≤–∞ DeepSeek API.

    Args:
        history: –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
        message: –¢–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        system_prompt: –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç

    Yields:
        str: –ß–∞—Å—Ç–∏ –æ—Ç–≤–µ—Ç–∞ –ø–æ –º–µ—Ä–µ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è
    """
    # TODO: —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å—Ç—Ä–∏–º–∏–Ω–≥, –∫–æ–≥–¥–∞ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è
    logger.warning("–°—Ç—Ä–∏–º–∏–Ω–≥ DeepSeek –µ—â—ë –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω")
    yield call_deepseek(history, message, system_prompt)