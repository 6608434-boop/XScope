#!/usr/bin/env python
# -*- coding: utf-8 -*-

"""
================================================================================
–§–ê–ô–õ: services/profile/get_by_id.py
–ù–ê–ó–ù–ê–ß–ï–ù–ò–ï: –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ ID
–ê–í–¢–û–†: Oliver Vance
–î–ê–¢–ê: 2026-02-14

–û–ü–ò–°–ê–ù–ò–ï:
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å –ø–æ —Å—Ç—Ä–æ–∫–æ–≤–æ–º—É –∏–ª–∏ —á–∏—Å–ª–æ–≤–æ–º—É ID.
    –ú–æ–∂–µ—Ç –≤–∫–ª—é—á–∞—Ç—å –ø–æ–ª–Ω—ã–π –ø—Ä–æ–º–ø—Ç –∏ –ø—Ä–∞–≤–∏–ª–∞.

–ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï:
    from services.profile.get_by_id import get_profile_by_id, get_profile_with_prompt

    # –ü–æ —Å—Ç—Ä–æ–∫–æ–≤–æ–º—É ID
    profile = get_profile_by_id('will')

    # –° –ø–æ–ª–Ω—ã–º –ø—Ä–æ–º–ø—Ç–æ–º –∏ –ø—Ä–∞–≤–∏–ª–∞–º–∏
    full_profile = get_profile_with_prompt(1)

–§–£–ù–ö–¶–ò–ò:
    get_profile_by_id(profile_id) - –ø—Ä–æ—Ñ–∏–ª—å –ø–æ —Å—Ç—Ä–æ–∫–æ–≤–æ–º—É ID
    get_profile_by_db_id(db_id) - –ø—Ä–æ—Ñ–∏–ª—å –ø–æ —á–∏—Å–ª–æ–≤–æ–º—É ID
    get_profile_with_prompt(profile_id) - —Å –ø—Ä–æ–º–ø—Ç–æ–º –∏ –ø—Ä–∞–≤–∏–ª–∞–º–∏

–ò–°–¢–û–†–ò–Ø –ò–ó–ú–ï–ù–ï–ù–ò–ô:
    2026-02-14 - Oliver - —Å–æ–∑–¥–∞–Ω–∏–µ
================================================================================
"""

from typing import Optional, Dict, Any, Union

from models.profile import BotProfile
from models.rule import ProfileRule

import logging

logger = logging.getLogger(__name__)


def get_profile_by_id(profile_id: str) -> Optional[Dict[str, Any]]:
    """
    –ü–æ–ª—É—á–∞–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å –ø–æ —Å—Ç—Ä–æ–∫–æ–≤–æ–º—É ID ('will', 'oliver', ...).

    Args:
        profile_id: –°—Ç—Ä–æ–∫–æ–≤—ã–π ID –ø—Ä–æ—Ñ–∏–ª—è

    Returns:
        Optional[Dict]: –î–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è –∏–ª–∏ None
    """
    logger.info(f"üîç –ü–æ–∏—Å–∫ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ ID: {profile_id}")

    profile = BotProfile.get_by_bot_id(profile_id)

    if profile:
        logger.debug(f"‚úÖ –ü—Ä–æ—Ñ–∏–ª—å {profile_id} –Ω–∞–π–¥–µ–Ω (ID –≤ –ë–î: {profile['id']})")
    else:
        logger.warning(f"‚ùå –ü—Ä–æ—Ñ–∏–ª—å {profile_id} –Ω–µ –Ω–∞–π–¥–µ–Ω")

    return profile


def get_profile_by_db_id(db_id: int) -> Optional[Dict[str, Any]]:
    """
    –ü–æ–ª—É—á–∞–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å –ø–æ —á–∏—Å–ª–æ–≤–æ–º—É ID –∏–∑ –ë–î.

    Args:
        db_id: –ß–∏—Å–ª–æ–≤–æ–π ID –ø—Ä–æ—Ñ–∏–ª—è

    Returns:
        Optional[Dict]: –î–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è –∏–ª–∏ None
    """
    logger.info(f"üîç –ü–æ–∏—Å–∫ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ DB ID: {db_id}")

    profile = BotProfile.get_by_id(db_id)

    if profile:
        logger.debug(f"‚úÖ –ü—Ä–æ—Ñ–∏–ª—å {profile['bot_id']} –Ω–∞–π–¥–µ–Ω")
    else:
        logger.warning(f"‚ùå –ü—Ä–æ—Ñ–∏–ª—å —Å ID {db_id} –Ω–µ –Ω–∞–π–¥–µ–Ω")

    return profile


def get_profile_with_prompt(profile_id: Union[str, int]) -> Optional[Dict[str, Any]]:
    """
    –ü–æ–ª—É—á–∞–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å —Å –ø–æ–ª–Ω—ã–º –ø—Ä–æ–º–ø—Ç–æ–º –∏ –ø—Ä–∞–≤–∏–ª–∞–º–∏.

    Args:
        profile_id: –°—Ç—Ä–æ–∫–æ–≤—ã–π –∏–ª–∏ —á–∏—Å–ª–æ–≤–æ–π ID

    Returns:
        Optional[Dict]: –ü—Ä–æ—Ñ–∏–ª—å —Å system_prompt –∏ –ø—Ä–∞–≤–∏–ª–∞–º–∏
    """
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø ID –∏ –ø–æ–ª—É—á–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å
    if isinstance(profile_id, str):
        profile = get_profile_by_id(profile_id)
    else:
        profile = get_profile_by_db_id(profile_id)

    if not profile:
        return None

    # –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∏–ª–∞
    rules = ProfileRule.get_for_profile(profile['id'])
    if rules:
        profile['rules'] = rules
        logger.debug(f"üìã –î–æ–±–∞–≤–ª–µ–Ω–æ {len(rules)} –ø—Ä–∞–≤–∏–ª –¥–ª—è –ø—Ä–æ—Ñ–∏–ª—è {profile['bot_id']}")

    return profile


def get_profile_id_mapping() -> Dict[str, int]:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª–æ–≤–∞—Ä—å –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è —Å—Ç—Ä–æ–∫–æ–≤—ã—Ö ID –≤ —á–∏—Å–ª–æ–≤—ã–µ.

    Returns:
        Dict[str, int]: {'oliver': 1, 'will': 2, ...}
    """
    profiles = BotProfile.get_all()

    mapping = {}
    for p in profiles:
        mapping[p['bot_id']] = p['id']

    logger.debug(f"üó∫Ô∏è –°–æ–∑–¥–∞–Ω–æ mapping –¥–ª—è {len(mapping)} –ø—Ä–æ—Ñ–∏–ª–µ–π")
    return mapping