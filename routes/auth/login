#!/usr/bin/env python
# -*- coding: utf-8 -*-

"""
================================================================================
–§–ê–ô–õ: routes/auth/login.py
–ù–ê–ó–ù–ê–ß–ï–ù–ò–ï: –°—Ç—Ä–∞–Ω–∏—Ü–∞ –≤—Ö–æ–¥–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ª–æ–≥–∏–Ω–∞
–ê–í–¢–û–†: Oliver Vance
–î–ê–¢–ê: 2026-02-14

–û–ü–ò–°–ê–ù–ò–ï:
    - GET /auth/login - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ñ–æ—Ä–º—É –≤—Ö–æ–¥–∞
    - POST /auth/login - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã

–ú–ê–†–®–†–£–¢:
    GET /auth/login
    POST /auth/login

–ò–°–¢–û–†–ò–Ø –ò–ó–ú–ï–ù–ï–ù–ò–ô:
    2026-02-14 - Oliver - —Å–æ–∑–¥–∞–Ω–∏–µ
================================================================================
"""

from flask import render_template, request, redirect, url_for, session, flash
from routes.auth import auth_bp
from services.user import authenticate_user

import logging

logger = logging.getLogger(__name__)


@auth_bp.route('/login', methods=['GET', 'POST'])
def login():
    """
    –°—Ç—Ä–∞–Ω–∏—Ü–∞ –≤—Ö–æ–¥–∞.

    GET: –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ñ–æ—Ä–º—É –≤—Ö–æ–¥–∞
    POST: –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å –∏ —Å–æ–∑–¥–∞—ë—Ç —Å–µ—Å—Å–∏—é
    """
    # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –≥–ª–∞–≤–Ω—É—é
    if 'user_id' in session:
        logger.debug(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {session.get('user_id')} —É–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –≥–ª–∞–≤–Ω—É—é")
        return redirect(url_for('main.index'))

    if request.method == 'POST':
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
        username = request.form.get('username', '').strip()
        password = request.form.get('password', '')

        logger.info(f"üîê –ü–æ–ø—ã—Ç–∫–∞ –≤—Ö–æ–¥–∞: {username}")

        if not username or not password:
            flash('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error')
            return render_template('login.html')

        # –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
        user = authenticate_user(username, password)

        if user:
            # –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥
            session['user_id'] = user['id']
            session['username'] = user['username']
            session.permanent = True

            logger.info(f"‚úÖ –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥: {username} (ID: {user['id']})")
            flash('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!', 'success')

            # –ï—Å–ª–∏ –µ—Å—Ç—å 2FA - –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É
            if user.get('twofa_enabled'):
                return redirect(url_for('auth.twofa'))

            return redirect(url_for('main.index'))
        else:
            # –ù–µ—É–¥–∞—á–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞
            logger.warning(f"‚ùå –ù–µ—É–¥–∞—á–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –≤—Ö–æ–¥–∞: {username}")
            flash('–ù–µ–≤–µ—Ä–Ω–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –ø–∞—Ä–æ–ª—å', 'error')

    # GET –∑–∞–ø—Ä–æ—Å - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
    return render_template('login.html')


@auth_bp.route('/login/test', methods=['GET'])
def test_login():
    """
    –í—Ä–µ–º–µ–Ω–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
    –°–æ–∑–¥–∞—ë—Ç —Ç–µ—Å—Ç–æ–≤—É—é —Å–µ—Å—Å–∏—é –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–∞—Ä–æ–ª—è.

    TODO: –£–¥–∞–ª–∏—Ç—å –ø–µ—Ä–µ–¥ –ø—Ä–æ–¥–∞–∫—à–Ω–æ–º!
    """
    logger.warning("‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω —Ç–µ—Å—Ç–æ–≤—ã–π –≤—Ö–æ–¥!")
    session['user_id'] = 1
    session['username'] = 'test_user'
    flash('–¢–µ—Å—Ç–æ–≤—ã–π –≤—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω', 'info')
    return redirect(url_for('main.index'))