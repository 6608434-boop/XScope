#!/usr/bin/env python
# -*- coding: utf-8 -*-

"""
================================================================================
–§–ê–ô–õ: routes/main/index.py
–ù–ê–ó–ù–ê–ß–ï–ù–ò–ï: –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
–ê–í–¢–û–†: Oliver Vance
–î–ê–¢–ê: 2026-02-14

–û–ü–ò–°–ê–ù–ò–ï:
    –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å —á–∞—Ç–∞–º–∏.
    –¢—Ä–µ–±—É–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.

–ú–ê–†–®–†–£–¢:
    GET /

–ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï:
    –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É

–ò–°–¢–û–†–ò–Ø –ò–ó–ú–ï–ù–ï–ù–ò–ô:
    2026-02-14 - Oliver - —Å–æ–∑–¥–∞–Ω–∏–µ
================================================================================
"""

from flask import render_template, session
from routes.main import main_bp
from utils.decorators import login_required
from services.chat import get_user_chats
from services.message import get_chat_history

import logging

logger = logging.getLogger(__name__)


@main_bp.route('/')
@login_required
def index():
    """
    –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å —á–∞—Ç–∞–º–∏.

    –ó–∞–≥—Ä—É–∂–∞–µ—Ç:
    - –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —á–∞—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    - –ò—Å—Ç–æ—Ä–∏—é —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞
    - –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

    Returns:
        str: –û—Ç—Ä–µ–Ω–¥–µ—Ä–µ–Ω–Ω—ã–π HTML
    """
    user_id = session['user_id']
    username = session.get('username', '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å')

    logger.info(f"üè† –ó–∞–≥—Ä—É–∑–∫–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")

    # 1. –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    chats = get_user_chats(user_id)

    # 2. –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —á–∞—Ç (–∏–∑ —Å–µ—Å—Å–∏–∏ –∏–ª–∏ –ø–µ—Ä–≤—ã–π –≤ —Å–ø–∏—Å–∫–µ)
    current_chat_id = session.get('current_chat_id')
    if not current_chat_id and chats:
        current_chat_id = chats[0]['id']
        session['current_chat_id'] = current_chat_id
        logger.debug(f"üìå –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Ç–µ–∫—É—â–∏–π —á–∞—Ç: {current_chat_id}")

    # 3. –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞
    history = []
    current_chat_title = "–ù–æ–≤—ã–π —á–∞—Ç"

    if current_chat_id:
        try:
            history = get_chat_history(user_id, current_chat_id)
            # –ù–∞—Ö–æ–¥–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞
            for chat in chats:
                if chat['id'] == current_chat_id:
                    current_chat_title = chat['title']
                    break
            logger.debug(f"üìú –ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(history)} —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è —á–∞—Ç–∞ {current_chat_id}")
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞ {current_chat_id}: {e}")
            history = []

    # 4. –†–µ–Ω–¥–µ—Ä–∏–º —à–∞–±–ª–æ–Ω
    return render_template(
        'index.html',
        chats=chats,
        history=history,
        username=username,
        current_chat_id=current_chat_id,
        current_chat_title=current_chat_title
    )