#!/usr/bin/env python
# -*- coding: utf-8 -*-

"""
================================================================================
–§–ê–ô–õ: routes/analyze/message.py
–ù–ê–ó–ù–ê–ß–ï–ù–ò–ï: –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –æ—Ç AI
–ê–í–¢–û–†: Oliver Vance
–î–ê–¢–ê: 2026-02-14

–û–ü–ò–°–ê–ù–ò–ï:
    –ü—Ä–∏–Ω–∏–º–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ AI –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç–≤–µ—Ç.

–ú–ê–†–®–†–£–¢:
    POST /analyze/message

–ò–°–¢–û–†–ò–Ø –ò–ó–ú–ï–ù–ï–ù–ò–ô:
    2026-02-14 - Oliver - —Å–æ–∑–¥–∞–Ω–∏–µ
================================================================================
"""

from flask import request, jsonify, session
from routes.analyze import analyze_bp
from utils.decorators import login_required
from services.message import send_message

import logging

logger = logging.getLogger(__name__)


@analyze_bp.route('/message', methods=['POST'])
@login_required
def analyze_message():
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç–≤–µ—Ç AI.

    Body:
        {
            "message": "–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è",
            "chat_id": 123
        }

    Returns:
        JSON: {
            "reply": "–û—Ç–≤–µ—Ç –æ—Ç AI",
            "chat_id": 123
        }
    """
    user_id = session['user_id']
    data = request.json

    message = data.get('message')
    chat_id = data.get('chat_id')

    if not message:
        logger.warning(f"‚ùå –ü—É—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
        return jsonify({
            'error': '–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º'
        }), 400

    if not chat_id:
        logger.warning(f"‚ùå –ù–µ —É–∫–∞–∑–∞–Ω chat_id –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
        return jsonify({
            'error': '–ù–µ —É–∫–∞–∑–∞–Ω ID —á–∞—Ç–∞'
        }), 400

    logger.info(f"üí¨ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç–µ {chat_id} –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
    logger.debug(f"üìù –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è: {message[:50]}...")

    try:
        result = send_message(user_id, chat_id, message)

        logger.info(f"‚úÖ –û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω –¥–ª—è —á–∞—Ç–∞ {chat_id}")

        return jsonify({
            'reply': result['reply'],
            'chat_id': chat_id
        })

    except ValueError as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏: {e}")
        return jsonify({
            'error': str(e)
        }), 400

    except PermissionError as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞: {e}")
        return jsonify({
            'error': str(e)
        }), 403

    except Exception as e:
        logger.error(f"‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")
        return jsonify({
            'error': '–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞'
        }), 500