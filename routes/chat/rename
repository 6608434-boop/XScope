#!/usr/bin/env python
# -*- coding: utf-8 -*-

"""
================================================================================
ФАЙЛ: routes/chat/rename.py
НАЗНАЧЕНИЕ: Переименование чата
АВТОР: Oliver Vance
ДАТА: 2026-02-14

ОПИСАНИЕ:
    Переименовывает существующий чат.
    Принимает JSON с ID чата и новым названием.

МАРШРУТ:
    POST /chat/rename

ИСТОРИЯ ИЗМЕНЕНИЙ:
    2026-02-14 - Oliver - создание
================================================================================
"""

from flask import request, jsonify, session
from routes.chat import chat_bp
from utils.decorators import login_required
from services.chat import rename_chat

import logging

logger = logging.getLogger(__name__)


@chat_bp.route('/rename', methods=['POST'])
@login_required
def rename():
    """
    Переименовывает чат.

    Body:
        {
            "chat_id": 123,
            "title": "Новое название"
        }

    Returns:
        JSON: {
            "success": true,
            "new_title": "Новое название"
        }
    """
    user_id = session['user_id']
    data = request.json

    chat_id = data.get('chat_id')
    new_title = data.get('title')

    if not chat_id or not new_title:
        return jsonify({
            'success': False,
            'error': 'Не указан chat_id или title'
        }), 400

    logger.info(f"✏️ Запрос на переименование чата {chat_id} от пользователя {user_id}")

    try:
        success = rename_chat(user_id, chat_id, new_title)

        if success:
            return jsonify({
                'success': True,
                'new_title': new_title
            })
        else:
            return jsonify({
                'success': False,
                'error': 'Ошибка при переименовании'
            }), 500

    except ValueError as e:
        logger.error(f"❌ Ошибка переименования: {e}")
        return jsonify({
            'success': False,
            'error': str(e)
        }), 400

    except PermissionError as e:
        logger.error(f"❌ Ошибка доступа: {e}")
        return jsonify({
            'success': False,
            'error': str(e)
        }), 403

    except Exception as e:
        logger.error(f"❌ Неожиданная ошибка: {e}")
        return jsonify({
            'success': False,
            'error': 'Внутренняя ошибка сервера'
        }), 500