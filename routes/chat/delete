#!/usr/bin/env python
# -*- coding: utf-8 -*-

"""
================================================================================
–§–ê–ô–ª: routes/chat/delete.py
–ù–ê–ó–ù–ê–ß–ï–ù–ò–ï: –£–¥–∞–ª–µ–Ω–∏–µ —á–∞—Ç–∞
–ê–í–¢–û–†: Oliver Vance
–î–ê–¢–ê: 2026-02-14

–û–ü–ò–°–ê–ù–ò–ï:
    –£–¥–∞–ª—è–µ—Ç —á–∞—Ç –ø–æ ID.
    –¢—Ä–µ–±—É–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è (–Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ).

–ú–ê–†–®–†–£–¢:
    POST /chat/delete/<int:chat_id>

–ò–°–¢–û–†–ò–Ø –ò–ó–ú–ï–ù–ï–ù–ò–ô:
    2026-02-14 - Oliver - —Å–æ–∑–¥–∞–Ω–∏–µ
================================================================================
"""

from flask import jsonify, session
from routes.chat import chat_bp
from utils.decorators import login_required
from services.chat import delete_chat

import logging

logger = logging.getLogger(__name__)


@chat_bp.route('/delete/<int:chat_id>', methods=['POST'])
@login_required
def delete(chat_id):
    """
    –£–¥–∞–ª—è–µ—Ç —á–∞—Ç.

    Args:
        chat_id: ID —É–¥–∞–ª—è–µ–º–æ–≥–æ —á–∞—Ç–∞

    Returns:
        JSON: {
            "success": true,
            "redirect": "/"
        }
    """
    user_id = session['user_id']

    logger.info(f"üóëÔ∏è –ó–∞–ø—Ä–æ—Å –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ —á–∞—Ç–∞ {chat_id} –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")

    try:
        success = delete_chat(user_id, chat_id)

        if success:
            # –ï—Å–ª–∏ —É–¥–∞–ª–∏–ª–∏ —Ç–µ–∫—É—â–∏–π —á–∞—Ç - —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤ —Å–µ—Å—Å–∏–∏
            if session.get('current_chat_id') == chat_id:
                session.pop('current_chat_id', None)
                logger.debug(f"–¢–µ–∫—É—â–∏–π —á–∞—Ç {chat_id} —É–¥–∞–ª—ë–Ω, —Å–±—Ä–æ—Å –≤ —Å–µ—Å—Å–∏–∏")

            return jsonify({
                'success': True,
                'redirect': '/'
            })
        else:
            return jsonify({
                'success': False,
                'error': '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —á–∞—Ç–∞'
            }), 500

    except ValueError as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: {e}")
        return jsonify({
            'success': False,
            'error': str(e)
        }), 400

    except PermissionError as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞: {e}")
        return jsonify({
            'success': False,
            'error': str(e)
        }), 403

    except Exception as e:
        logger.error(f"‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: {e}")
        return jsonify({
            'success': False,
            'error': '–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞'
        }), 500