#!/usr/bin/env python
# -*- coding: utf-8 -*-

"""
================================================================================
–§–ê–ô–õ: routes/chat/new.py
–ù–ê–ó–ù–ê–ß–ï–ù–ò–ï: –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —á–∞—Ç–∞
–ê–í–¢–û–†: Oliver Vance
–î–ê–¢–ê: 2026-02-14

–û–ü–ò–°–ê–ù–ò–ï:
    –°–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–π —á–∞—Ç.
    –ü—Ä–∏–Ω–∏–º–∞–µ—Ç JSON —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º –∏ ID –ø—Ä–æ—Ñ–∏–ª—è.

–ú–ê–†–®–†–£–¢:
    POST /chat/new

–ò–°–¢–û–†–ò–Ø –ò–ó–ú–ï–ù–ï–ù–ò–ô:
    2026-02-14 - Oliver - —Å–æ–∑–¥–∞–Ω–∏–µ
================================================================================
"""

from flask import request, jsonify, session
from routes.chat import chat_bp
from utils.decorators import login_required
from services.chat import create_chat

import logging

logger = logging.getLogger(__name__)


@chat_bp.route('/new', methods=['POST'])
@login_required
def new_chat():
    """
    –°–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–π —á–∞—Ç.

    Body:
        {
            "title": "–ù–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞",
            "bot_profile_id": "will"  # –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
        }

    Returns:
        JSON: {
            "success": true,
            "chat_id": 123,
            "redirect": "/chat/load/123"
        }
    """
    user_id = session['user_id']
    data = request.json

    title = data.get('title', '–ù–æ–≤—ã–π —á–∞—Ç')
    bot_profile_id = data.get('bot_profile_id')

    logger.info(f"üöÄ –ó–∞–ø—Ä–æ—Å –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ —á–∞—Ç–∞ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")

    try:
        chat_id = create_chat(user_id, title, bot_profile_id)

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –Ω–æ–≤–æ–≥–æ —á–∞—Ç–∞ –≤ —Å–µ—Å—Å–∏–∏
        session['current_chat_id'] = chat_id

        return jsonify({
            'success': True,
            'chat_id': chat_id,
            'redirect': f'/chat/load/{chat_id}'
        })

    except ValueError as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —á–∞—Ç–∞: {e}")
        return jsonify({
            'success': False,
            'error': str(e)
        }), 400

    except Exception as e:
        logger.error(f"‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: {e}")
        return jsonify({
            'success': False,
            'error': '–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞'
        }), 500