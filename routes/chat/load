#!/usr/bin/env python
# -*- coding: utf-8 -*-

"""
================================================================================
–§–ê–ô–õ: routes/chat/load.py
–ù–ê–ó–ù–ê–ß–ï–ù–ò–ï: –ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–∞
–ê–í–¢–û–†: Oliver Vance
–î–ê–¢–ê: 2026-02-14

–û–ü–ò–°–ê–ù–ò–ï:
    –ó–∞–≥—Ä—É–∂–∞–µ—Ç —á–∞—Ç –ø–æ ID –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –µ–≥–æ –∫–∞–∫ —Ç–µ–∫—É—â–∏–π –≤ —Å–µ—Å—Å–∏–∏.
    –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å –æ—Ç–∫—Ä—ã—Ç—ã–º —á–∞—Ç–æ–º.

–ú–ê–†–®–†–£–¢:
    GET /chat/load/<int:chat_id>

–ò–°–¢–û–†–ò–Ø –ò–ó–ú–ï–ù–ï–ù–ò–ô:
    2026-02-14 - Oliver - —Å–æ–∑–¥–∞–Ω–∏–µ
================================================================================
"""

from flask import redirect, url_for, session, jsonify
from routes.chat import chat_bp
from utils.decorators import login_required
from services.chat import load_chat

import logging

logger = logging.getLogger(__name__)


@chat_bp.route('/load/<int:chat_id>')
@login_required
def load(chat_id):
    """
    –ó–∞–≥—Ä—É–∂–∞–µ—Ç —á–∞—Ç –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –µ–≥–æ –∫–∞–∫ —Ç–µ–∫—É—â–∏–π.

    Args:
        chat_id: ID –∑–∞–≥—Ä—É–∂–∞–µ–º–æ–≥–æ —á–∞—Ç–∞

    Returns:
        Redirect –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
        –ò–ª–∏ JSON –¥–ª—è API –∑–∞–ø—Ä–æ—Å–æ–≤
    """
    user_id = session['user_id']

    logger.info(f"üìÇ –ó–∞–ø—Ä–æ—Å –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É —á–∞—Ç–∞ {chat_id} –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ–∂–∏–¥–∞–µ—Ç –ª–∏ –∫–ª–∏–µ–Ω—Ç JSON
    from utils.decorators import request_wants_json

    try:
        # –ó–∞–≥—Ä—É–∂–∞–µ–º —á–∞—Ç (—Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –¥–æ—Å—Ç—É–ø–∞)
        chat_data = load_chat(user_id, chat_id)

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –≤ —Å–µ—Å—Å–∏–∏
        session['current_chat_id'] = chat_id

        logger.info(f"‚úÖ –ß–∞—Ç {chat_id} –∑–∞–≥—Ä—É–∂–µ–Ω, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∫–∞–∫ —Ç–µ–∫—É—â–∏–π")

        # –î–ª—è API –∑–∞–ø—Ä–æ—Å–æ–≤ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º JSON
        if request_wants_json():
            return jsonify({
                'success': True,
                'chat': chat_data['chat'],
                'history': chat_data['history'],
                'profile': chat_data['profile']
            })

        # –î–ª—è –æ–±—ã—á–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ - —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –≥–ª–∞–≤–Ω—É—é
        return redirect(url_for('main.index'))

    except ValueError as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–∞ {chat_id}: {e}")

        if request_wants_json():
            return jsonify({
                'success': False,
                'error': str(e)
            }), 404

        return redirect(url_for('main.index'))

    except PermissionError as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —á–∞—Ç—É {chat_id}: {e}")

        if request_wants_json():
            return jsonify({
                'success': False,
                'error': str(e)
            }), 403

        return redirect(url_for('main.index'))

    except Exception as e:
        logger.error(f"‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —á–∞—Ç–∞ {chat_id}: {e}")

        if request_wants_json():
            return jsonify({
                'success': False,
                'error': '–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞'
            }), 500

        return redirect(url_for('main.index'))