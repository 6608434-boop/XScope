#!/usr/bin/env python
# -*- coding: utf-8 -*-

"""
================================================================================
–§–ê–ô–õ: core/cli/load_profiles.py
–ù–ê–ó–ù–ê–ß–ï–ù–ò–ï: CLI –∫–æ–º–∞–Ω–¥–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª–µ–π –±–æ—Ç–æ–≤
–ê–í–¢–û–†: Oliver Vance
–î–ê–¢–ê: 2026-02-15

–û–ü–ò–°–ê–ù–ò–ï:
    –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è Flask CLI: flask load-profiles
    –ó–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ –ø—Ä–æ—Ñ–∏–ª–∏ –∏–∑ –ø–∞–ø–∫–∏ prompts/ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö.

–ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï:
    flask load-profiles
    flask load-profiles --bot will  # –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ–≥–æ

–ò–°–¢–û–†–ò–Ø –ò–ó–ú–ï–ù–ï–ù–ò–ô:
    2026-02-15 - Oliver - —Å–æ–∑–¥–∞–Ω–∏–µ
================================================================================
"""

import click
from flask.cli import with_appcontext
import logging

from core.profiles.loader import load_profiles, reload_profile

logger = logging.getLogger(__name__)


@click.command('load-profiles')
@click.option('--bot', '-b', help='–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–æ–ª—å–∫–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –±–æ—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä --bot will)')
@click.option('--dir', 'prompts_dir', default='prompts', help='–ü–∞–ø–∫–∞ —Å –ø—Ä–æ–º–ø—Ç–∞–º–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é prompts)')
@with_appcontext
def load_profiles_command(bot, prompts_dir):
    """
    –ó–∞–≥—Ä—É–∂–∞–µ—Ç –ø—Ä–æ—Ñ–∏–ª–∏ –±–æ—Ç–æ–≤ –∏–∑ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤.

    –ü—Ä–∏–º–µ—Ä—ã:
        flask load-profiles              # –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ—Ö
        flask load-profiles --bot will   # –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–æ–ª—å–∫–æ –£–∏–ª–ª–∞
        flask load-profiles --dir custom_prompts
    """
    if bot:
        click.echo(f"ü§ñ –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è {bot}...")

        try:
            success = reload_profile(bot)
            if success:
                click.echo(f"‚úÖ –ü—Ä–æ—Ñ–∏–ª—å {bot} —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω!")
            else:
                click.echo(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è {bot}", err=True)
        except Exception as e:
            click.echo(f"‚ùå –û—à–∏–±–∫–∞: {e}", err=True)

    else:
        click.echo(f"üìÇ –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π –∏–∑ {prompts_dir}/...")

        try:
            stats = load_profiles(prompts_dir)

            click.echo(f"\nüìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã:")
            click.echo(f"   –í—Å–µ–≥–æ —Ñ–∞–π–ª–æ–≤: {stats['total']}")
            click.echo(f"   ‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ: {stats['loaded']}")

            if stats['failed']:
                click.echo(f"   ‚ùå –û—à–∏–±–æ–∫: {stats['failed']}")
            if stats['skipped']:
                click.echo(f"   ‚ö†Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–æ: {stats['skipped']}")

            if stats['loaded'] > 0:
                click.echo(f"\n‚úÖ –ü—Ä–æ—Ñ–∏–ª–∏ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –≤ –ë–î!")
            else:
                click.echo(f"\n‚ö†Ô∏è –ù–∏ –æ–¥–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ")

        except Exception as e:
            click.echo(f"‚ùå –û—à–∏–±–∫–∞: {e}", err=True)


@click.command('list-profiles')
@with_appcontext
def list_profiles_command():
    """
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.

    –ü—Ä–∏–º–µ—Ä:
        flask list-profiles
    """
    from models.profile import BotProfile

    click.echo("üìã –°–ø–∏—Å–æ–∫ –ø—Ä–æ—Ñ–∏–ª–µ–π –≤ –ë–î:")

    profiles = BotProfile.get_all()

    if not profiles:
        click.echo("   –ü—Ä–æ—Ñ–∏–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")
        return

    for p in profiles:
        click.echo(f"   {p['avatar']} {p['bot_name']} ({p['bot_id']})")

    click.echo(f"\n   –í—Å–µ–≥–æ: {len(profiles)} –ø—Ä–æ—Ñ–∏–ª–µ–π")