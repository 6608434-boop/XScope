#!/usr/bin/env python
# -*- coding: utf-8 -*-

"""
================================================================================
–§–ê–ô–õ: core/hooks/error_handlers.py
–ù–ê–ó–ù–ê–ß–ï–ù–ò–ï: –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –æ—à–∏–±–æ–∫ –¥–ª—è Flask –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
–ê–í–¢–û–†: Oliver Vance
–î–ê–¢–ê: 2026-02-15

–û–ü–ò–°–ê–ù–ò–ï:
    –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –∫–∞—Å—Ç–æ–º–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–ª—è –æ—à–∏–±–æ–∫ HTTP:
    - 404 - —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞
    - 403 - –¥–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω
    - 500 - –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞

–ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï:
    from core.hooks import setup_error_handlers
    setup_error_handlers(app)

–ò–°–¢–û–†–ò–Ø –ò–ó–ú–ï–ù–ï–ù–ò–ô:
    2026-02-15 - Oliver - —Å–æ–∑–¥–∞–Ω–∏–µ
================================================================================
"""

from flask import Flask, render_template, jsonify, request
import logging

logger = logging.getLogger(__name__)


def request_wants_json():
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –æ–∂–∏–¥–∞–µ—Ç –ª–∏ –∫–ª–∏–µ–Ω—Ç JSON –æ—Ç–≤–µ—Ç.
    """
    best = request.accept_mimetypes.best_match(['application/json', 'text/html'])
    return best == 'application/json' and \
           request.accept_mimetypes[best] > request.accept_mimetypes['text/html']


def setup_error_handlers(app: Flask):
    """
    –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –æ—à–∏–±–æ–∫.

    Args:
        app: Flask –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    """
    logger.info("üõ†Ô∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –æ—à–∏–±–æ–∫...")

    @app.errorhandler(404)
    def not_found_error(error):
        """–°—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"""
        logger.debug(f"404 –æ—à–∏–±–∫–∞: {request.path}")

        if request_wants_json():
            return jsonify({
                'error': 'Not Found',
                'message': '–°—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'
            }), 404

        return render_template('errors/404.html'), 404

    @app.errorhandler(403)
    def forbidden_error(error):
        """–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω"""
        logger.warning(f"403 –æ—à–∏–±–∫–∞: {request.path}")

        if request_wants_json():
            return jsonify({
                'error': 'Forbidden',
                'message': '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω'
            }), 403

        return render_template('errors/403.html'), 403

    @app.errorhandler(500)
    def internal_error(error):
        """–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞"""
        logger.error(f"500 –æ—à–∏–±–∫–∞: {error}")

        if request_wants_json():
            return jsonify({
                'error': 'Internal Server Error',
                'message': '–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞'
            }), 500

        return render_template('errors/500.html'), 500

    @app.errorhandler(401)
    def unauthorized_error(error):
        """–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω"""
        logger.debug(f"401 –æ—à–∏–±–∫–∞: {request.path}")

        if request_wants_json():
            return jsonify({
                'error': 'Unauthorized',
                'message': '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è'
            }), 401

        return render_template('errors/401.html'), 401

    @app.errorhandler(400)
    def bad_request_error(error):
        """–ù–µ–≤–µ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å"""
        logger.debug(f"400 –æ—à–∏–±–∫–∞: {request.path}")

        if request_wants_json():
            return jsonify({
                'error': 'Bad Request',
                'message': str(error.description) if error.description else '–ù–µ–≤–µ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å'
            }), 400

        return render_template('errors/400.html'), 400

    logger.info("‚úÖ –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –æ—à–∏–±–æ–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã")