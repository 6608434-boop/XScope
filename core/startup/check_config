#!/usr/bin/env python
# -*- coding: utf-8 -*-

"""
================================================================================
ФАЙЛ: core/startup/check_config.py
НАЗНАЧЕНИЕ: Проверка конфигурации при старте
АВТОР: Oliver Vance
ДАТА: 2026-02-15

ОПИСАНИЕ:
    Проверяет наличие обязательных параметров в конфигурации.
    Логирует предупреждения, но не останавливает приложение (кроме критичных).

ИСПОЛЬЗОВАНИЕ:
    from core.startup import check_config
    check_config()

ИСТОРИЯ ИЗМЕНЕНИЙ:
    2026-02-15 - Oliver - создание
================================================================================
"""

import logging
from config import config
from config.api_keys import APIConfig
from config.features import FeatureConfig

logger = logging.getLogger(__name__)


def check_config():
    """
    Проверяет конфигурацию при старте приложения.
    Выводит предупреждения, но не останавливает работу.
    """
    logger.info("🔍 Проверка конфигурации...")

    # ===== Проверка базы данных =====
    if not config.DATABASE_URL:
        logger.error("❌ DATABASE_URL не задан! Приложение не сможет работать без базы данных.")
        # Это критично - приложение не запустится
        raise ValueError("DATABASE_URL is required")
    else:
        # Маскируем пароль в логах
        db_display = config.DATABASE_URL.split('@')[-1] if '@' in config.DATABASE_URL else config.DATABASE_URL
        logger.info(f"✅ DATABASE_URL: ...{db_display}")

    # ===== Проверка секретного ключа =====
    if config.SECRET_KEY == 'your-secret-key-here-change-in-production':
        logger.warning("⚠️ SECRET_KEY использует значение по умолчанию! Измените его в .env для продакшна.")
    else:
        logger.info("✅ SECRET_KEY: установлен")

    # ===== Проверка API ключей =====
    api_status = APIConfig.validate_all()

    if api_status['deepseek']:
        logger.info("✅ DeepSeek API: ключ найден")
    else:
        logger.warning("⚠️ DeepSeek API: ключ не найден (AI функции будут недоступны)")

    if api_status['telegram']:
        logger.info("✅ Telegram API: ключ найден")
    else:
        logger.info("ℹ️ Telegram API: ключ не задан (интеграция отключена)")

    # ===== Проверка флагов функций =====
    feature_status = FeatureConfig.get_feature_status()
    enabled_profiles = feature_status['enabled_profiles']

    logger.info(f"📊 Флаги функций: 2FA {'✅' if feature_status['features']['2fa'] else '❌'}, "
                f"Telegram {'✅' if feature_status['features']['telegram'] else '❌'}, "
                f"DeepSeek {'✅' if feature_status['features']['deepseek'] else '❌'}")

    logger.info(f"📊 Включено профилей: {feature_status['profiles_count']}/9")
    if enabled_profiles:
        logger.debug(f"   Профили: {', '.join(enabled_profiles)}")

    # ===== Проверка режима обслуживания =====
    if config.MAINTENANCE_MODE:
        logger.warning(f"🚧 Режим обслуживания ВКЛЮЧЕН: {config.MAINTENANCE_MESSAGE}")

    # ===== Проверка окружения =====
    logger.info(f"🌍 Окружение: {config.FLASK_ENV}")

    if config.IS_PRODUCTION:
        logger.info("🏭 Продакшн режим")
    elif config.IS_DEVELOPMENT:
        logger.info("💻 Режим разработки")
    elif config.IS_TESTING:
        logger.info("🧪 Режим тестирования")

    logger.info("✅ Проверка конфигурации завершена")


def print_banner():
    """
    Выводит красивый баннер при запуске.
    """
    banner = """
    ╔══════════════════════════════════════════════════════════╗
    ║                                                          ║
    ║   ██╗  ██╗███████╗ ██████╗ ██████╗ ██████╗ ███████╗    ║
    ║   ╚██╗██╔╝██╔════╝██╔════╝██╔═══██╗██╔══██╗██╔════╝    ║
    ║    ╚███╔╝ ███████╗██║     ██║   ██║██████╔╝█████╗      ║
    ║    ██╔██╗ ╚════██║██║     ██║   ██║██╔═══╝ ██╔══╝      ║
    ║   ██╔╝ ██╗███████║╚██████╗╚██████╔╝██║     ███████╗    ║
    ║   ╚═╝  ╚═╝╚══════╝ ╚═════╝ ╚═════╝ ╚═╝     ╚══════╝    ║
    ║                                                          ║
    ║               AI-аналитика для X/Twitter                ║
    ║                                                          ║
    ╚══════════════════════════════════════════════════════════╝
    """
    print(banner)