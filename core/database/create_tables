#!/usr/bin/env python
# -*- coding: utf-8 -*-

"""
================================================================================
–§–ê–ô–õ: core/database/create_tables.py
–ù–ê–ó–ù–ê–ß–ï–ù–ò–ï: –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
–ê–í–¢–û–†: Oliver Vance
–î–ê–¢–ê: 2026-02-15

–û–ü–ò–°–ê–ù–ò–ï:
    –°–æ–∑–¥–∞—ë—Ç –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ç–∞–±–ª–∏—Ü—ã, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç.
    –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

–ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï:
    from core.database import init_db
    init_db()

–ò–°–¢–û–†–ò–Ø –ò–ó–ú–ï–ù–ï–ù–ò–ô:
    2026-02-15 - Oliver - —Å–æ–∑–¥–∞–Ω–∏–µ
================================================================================
"""

import logging
from utils.db import get_db_connection

logger = logging.getLogger(__name__)


def init_db():
    """
    –°–æ–∑–¥–∞—ë—Ç –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.
    –ë–µ–∑–æ–ø–∞—Å–Ω–æ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç IF NOT EXISTS).
    """
    logger.info("üóÑÔ∏è –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–∞–±–ª–∏—Ü –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...")

    conn = get_db_connection()
    cur = conn.cursor()

    try:
        # ===== –¢–∞–±–ª–∏—Ü–∞ users =====
        cur.execute("""
            CREATE TABLE IF NOT EXISTS users (
                id SERIAL PRIMARY KEY,
                username VARCHAR(80) UNIQUE NOT NULL,
                password_hash VARCHAR(200) NOT NULL,
                twofa_secret VARCHAR(32),
                twofa_enabled BOOLEAN DEFAULT FALSE,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        """)
        logger.debug("‚úÖ –¢–∞–±–ª–∏—Ü–∞ users –≥–æ—Ç–æ–≤–∞")

        # ===== –¢–∞–±–ª–∏—Ü–∞ bot_profiles =====
        cur.execute("""
            CREATE TABLE IF NOT EXISTS bot_profiles (
                id SERIAL PRIMARY KEY,
                bot_id VARCHAR(50) UNIQUE NOT NULL,
                bot_name VARCHAR(100) NOT NULL,
                avatar VARCHAR(10) NOT NULL,
                system_prompt TEXT NOT NULL,
                description TEXT,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        """)
        logger.debug("‚úÖ –¢–∞–±–ª–∏—Ü–∞ bot_profiles –≥–æ—Ç–æ–≤–∞")

        # ===== –¢–∞–±–ª–∏—Ü–∞ chats =====
        cur.execute("""
            CREATE TABLE IF NOT EXISTS chats (
                id SERIAL PRIMARY KEY,
                user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
                title VARCHAR(200) NOT NULL,
                bot_profile_id INTEGER REFERENCES bot_profiles(id) ON DELETE SET NULL,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        """)
        logger.debug("‚úÖ –¢–∞–±–ª–∏—Ü–∞ chats –≥–æ—Ç–æ–≤–∞")

        # ===== –¢–∞–±–ª–∏—Ü–∞ messages =====
        cur.execute("""
            CREATE TABLE IF NOT EXISTS messages (
                id SERIAL PRIMARY KEY,
                chat_id INTEGER NOT NULL REFERENCES chats(id) ON DELETE CASCADE,
                role VARCHAR(20) NOT NULL CHECK (role IN ('user', 'assistant')),
                content TEXT NOT NULL,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        """)
        logger.debug("‚úÖ –¢–∞–±–ª–∏—Ü–∞ messages –≥–æ—Ç–æ–≤–∞")

        # ===== –¢–∞–±–ª–∏—Ü–∞ profile_rules =====
        cur.execute("""
            CREATE TABLE IF NOT EXISTS profile_rules (
                id SERIAL PRIMARY KEY,
                profile_id INTEGER NOT NULL REFERENCES bot_profiles(id) ON DELETE CASCADE,
                rule_text TEXT NOT NULL,
                priority VARCHAR(10) DEFAULT '‚Ä¢' CHECK (priority IN ('‚ùó', 'üìå', '‚Ä¢')),
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        """)
        logger.debug("‚úÖ –¢–∞–±–ª–∏—Ü–∞ profile_rules –≥–æ—Ç–æ–≤–∞")

        # ===== –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è =====
        cur.execute("CREATE INDEX IF NOT EXISTS idx_chats_user_id ON chats(user_id)")
        cur.execute("CREATE INDEX IF NOT EXISTS idx_messages_chat_id ON messages(chat_id)")
        cur.execute("CREATE INDEX IF NOT EXISTS idx_rules_profile_id ON profile_rules(profile_id)")
        logger.debug("‚úÖ –ò–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞–Ω—ã")

        conn.commit()
        logger.info("‚úÖ –í—Å–µ —Ç–∞–±–ª–∏—Ü—ã —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω—ã/–ø—Ä–æ–≤–µ—Ä–µ–Ω—ã")

    except Exception as e:
        conn.rollback()
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü: {e}")
        raise
    finally:
        cur.close()
        conn.close()


def drop_all_tables():
    """
    –£–¥–∞–ª—è–µ—Ç –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã (–¥–ª—è —Ç–µ—Å—Ç–æ–≤).
    –ë—É–¥—å—Ç–µ –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã - —ç—Ç–æ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ!
    """
    logger.warning("‚ö†Ô∏è –£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü!")

    conn = get_db_connection()
    cur = conn.cursor()

    try:
        cur.execute("DROP TABLE IF EXISTS profile_rules CASCADE")
        cur.execute("DROP TABLE IF EXISTS messages CASCADE")
        cur.execute("DROP TABLE IF EXISTS chats CASCADE")
        cur.execute("DROP TABLE IF EXISTS bot_profiles CASCADE")
        cur.execute("DROP TABLE IF EXISTS users CASCADE")

        conn.commit()
        logger.info("‚úÖ –í—Å–µ —Ç–∞–±–ª–∏—Ü—ã —É–¥–∞–ª–µ–Ω—ã")

    except Exception as e:
        conn.rollback()
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü: {e}")
        raise
    finally:
        cur.close()
        conn.close()