#!/usr/bin/env python
# -*- coding: utf-8 -*-

"""
================================================================================
–§–ê–ô–õ: core/profiles/loader.py
–ù–ê–ó–ù–ê–ß–ï–ù–ò–ï: –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª–µ–π –±–æ—Ç–æ–≤ –∏–∑ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤
–ê–í–¢–û–†: Oliver Vance
–î–ê–¢–ê: 2026-02-15

–û–ü–ò–°–ê–ù–ò–ï:
    –ß–∏—Ç–∞–µ—Ç –≤—Å–µ .txt —Ñ–∞–π–ª—ã –∏–∑ –ø–∞–ø–∫–∏ prompts/ –∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –∏—Ö –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö.
    –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø—Ä–æ—Ñ–∏–ª–∏, —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–µ.

–ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï:
    from core.profiles import load_profiles
    load_profiles()

–ò–°–¢–û–†–ò–Ø –ò–ó–ú–ï–ù–ï–ù–ò–ô:
    2026-02-15 - Oliver - —Å–æ–∑–¥–∞–Ω–∏–µ
================================================================================
"""

import os
from pathlib import Path
import logging

from models.profile import BotProfile

logger = logging.getLogger(__name__)

# –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª–µ–π (–∏–º—è, –∞–≤–∞—Ç–∞—Ä, –æ–ø–∏—Å–∞–Ω–∏–µ)
PROFILES_META = {
    'oliver': {
        'name': 'Oliver Vance',
        'avatar': 'ùïè',
        'description': 'Twitter-—Å—Ç—Ä–∞—Ç–µ–≥, –∞—Ä–±–∏—Ç—Ä–∞–∂ —Ç—Ä–∞—Ñ–∏–∫–∞, –∞–Ω—Ç–∏–¥–µ—Ç–µ–∫—Ç'
    },
    'logan': {
        'name': '–õ–æ–≥–∞–Ω',
        'avatar': 'üë®‚ÄçüöÄ',
        'description': '–ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä –∫–æ–¥–∞, –≤–µ—Ç–µ—Ä–∞–Ω NASA, –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫'
    },
    'arseniy': {
        'name': '–ê—Ä—Å–µ–Ω–∏–π',
        'avatar': '–Ø',
        'description': '–Ø–Ω–¥–µ–∫—Å.–î–∏—Ä–µ–∫—Ç, —Å–µ–º–∞–Ω—Ç–∏–∫–∞, –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞'
    },
    'victor': {
        'name': 'Victor',
        'avatar': 'G',
        'description': 'Google Ads, PMax, GA4'
    },
    'mark': {
        'name': '–ú–∞—Ä–∫',
        'avatar': '‚ù§Ô∏è',
        'description': '–î—Ä—É–≥, –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫, –ø—Å–∏—Ö–æ–ª–æ–≥–∏—è, –ò–ò'
    },
    'teo': {
        'name': '–¢–µ–æ',
        'avatar': 'üì±',
        'description': 'Telegram API, –±–æ—Ç—ã, –∫–∞–Ω–∞–ª—ã, —Ä–µ–∫–ª–∞–º–∞'
    },
    'adam': {
        'name': '–ê–¥–∞–º',
        'avatar': 'üíò',
        'description': '–ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–ª—è –∑–Ω–∞–∫–æ–º—Å—Ç–≤, –ø—Å–∏—Ö–æ–ª–æ–≥–∏—è'
    },
    'steve': {
        'name': '–°—Ç–∏–≤',
        'avatar': 'üçè',
        'description': 'iOS-—Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫, SwiftUI, App Store'
    },
    'will': {
        'name': '–£–∏–ª–ª –ö—É–ø–µ—Ä',
        'avatar': 'ü§†',
        'description': '–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫, –∫—É–ª—å—Ç—É—Ä–∞ –°–®–ê, —ç–∫—Å-–º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥ Coca-Cola'
    },
    'paul': {
        'name': '–ü–æ—É–ª –ö—É–ø–µ—Ä',
        'avatar': 'üß†',
        'description': '–ù–∞—Å—Ç–∞–≤–Ω–∏–∫ –ø–æ –ø—Ä–æ–¥–∞–∫—Ç-–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç—É, –≤–µ—Ç–µ—Ä–∞–Ω Apple, Facebook, Telegram'
    },
}


def load_profile_from_file(bot_id: str, file_path: Path) -> bool:
    """
    –ó–∞–≥—Ä—É–∂–∞–µ—Ç –æ–¥–∏–Ω –ø—Ä–æ—Ñ–∏–ª—å –∏–∑ —Ñ–∞–π–ª–∞.

    Args:
        bot_id: –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–æ—Ç–∞
        file_path: –ü—É—Ç—å –∫ .txt —Ñ–∞–π–ª—É

    Returns:
        bool: True –µ—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω
    """
    try:
        with open(file_path, 'r', encoding='utf-8') as f:
            prompt = f.read().strip()

        if not prompt:
            logger.warning(f"‚ö†Ô∏è –§–∞–π–ª {file_path} –ø—É—Å—Ç")
            return False

        meta = PROFILES_META.get(bot_id)
        if not meta:
            logger.warning(f"‚ö†Ô∏è –ù–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –¥–ª—è {bot_id}")
            return False

        # –°–æ–∑–¥–∞—ë–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å –≤ –ë–î
        BotProfile.create_or_update(
            bot_id=bot_id,
            name=meta['name'],
            avatar=meta['avatar'],
            prompt=prompt,
            description=meta['description']
        )

        logger.info(f"‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω –ø—Ä–æ—Ñ–∏–ª—å {bot_id} ({len(prompt)} —Å–∏–º–≤–æ–ª–æ–≤)")
        return True

    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ {file_path}: {e}")
        return False


def load_profiles(prompts_dir: str = 'prompts') -> dict:
    """
    –ó–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ –ø—Ä–æ—Ñ–∏–ª–∏ –∏–∑ –ø–∞–ø–∫–∏ prompts/.

    Args:
        prompts_dir: –ü—É—Ç—å –∫ –ø–∞–ø–∫–µ —Å –ø—Ä–æ–º–ø—Ç–∞–º–∏

    Returns:
        dict: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ {total: N, loaded: N, failed: N}
    """
    logger.info("üìÇ –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª–µ–π –±–æ—Ç–æ–≤...")

    prompts_path = Path(prompts_dir)
    if not prompts_path.exists():
        logger.error(f"‚ùå –ü–∞–ø–∫–∞ {prompts_dir} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
        return {'total': 0, 'loaded': 0, 'failed': 0}

    # –ò—â–µ–º –≤—Å–µ .txt —Ñ–∞–π–ª—ã
    txt_files = list(prompts_path.glob('*.txt'))
    logger.info(f"üîç –ù–∞–π–¥–µ–Ω–æ {len(txt_files)} —Ñ–∞–π–ª–æ–≤ —Å –ø—Ä–æ–º–ø—Ç–∞–º–∏")

    stats = {
        'total': len(txt_files),
        'loaded': 0,
        'failed': 0,
        'skipped': 0
    }

    for file_path in txt_files:
        bot_id = file_path.stem  # –∏–º—è —Ñ–∞–π–ª–∞ –±–µ–∑ .txt

        if bot_id not in PROFILES_META:
            logger.warning(f"‚ö†Ô∏è –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å {bot_id}, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º")
            stats['skipped'] += 1
            continue

        if load_profile_from_file(bot_id, file_path):
            stats['loaded'] += 1
        else:
            stats['failed'] += 1

    logger.info(f"üìä –ò—Ç–æ–≥: –∑–∞–≥—Ä—É–∂–µ–Ω–æ {stats['loaded']}, –æ—à–∏–±–æ–∫ {stats['failed']}, –ø—Ä–æ–ø—É—â–µ–Ω–æ {stats['skipped']}")

    return stats


def reload_profile(bot_id: str) -> bool:
    """
    –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ—Ç –æ–¥–∏–Ω –ø—Ä–æ—Ñ–∏–ª—å (–ø–æ–ª–µ–∑–Ω–æ –ø—Ä–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ).

    Args:
        bot_id: –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–æ—Ç–∞

    Returns:
        bool: True –µ—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ
    """
    file_path = Path('prompts') / f"{bot_id}.txt"

    if not file_path.exists():
        logger.error(f"‚ùå –§–∞–π–ª {file_path} –Ω–µ –Ω–∞–π–¥–µ–Ω")
        return False

    return load_profile_from_file(bot_id, file_path)