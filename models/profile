#!/usr/bin/env python
# -*- coding: utf-8 -*-

"""
================================================================================
ФАЙЛ: models/profile.py
НАЗНАЧЕНИЕ: Модель профиля бота
АВТОР: Oliver Vance
ДАТА: 2026-02-14

ОПИСАНИЕ:
    Работа с таблицей bot_profiles:
    - Получение всех профилей
    - Получение профиля по ID
    - Загрузка промптов
    - Фильтрация по feature flags

ИСПОЛЬЗОВАНИЕ:
    from models.profile import BotProfile

    # Все профили
    profiles = BotProfile.get_all()

    # Профиль по строковому ID
    will = BotProfile.get_by_bot_id('will')

ИСТОРИЯ ИЗМЕНЕНИЙ:
    2026-02-14 - Oliver - создание
================================================================================
"""

from typing import List, Dict, Any, Optional

from utils.db import get_db_connection, get_dict_cursor, execute_dict_one
from models.base import BaseModel
from config.features import FeatureConfig

import logging

logger = logging.getLogger(__name__)


class BotProfile(BaseModel):
    """
    Модель профиля бота.

    Таблица: bot_profiles
    Поля:
        id: SERIAL PRIMARY KEY
        bot_id: VARCHAR(50) UNIQUE NOT NULL  # строковый ID ('oliver', 'will')
        bot_name: VARCHAR(100) NOT NULL      # отображаемое имя
        avatar: VARCHAR(10) NOT NULL          # эмодзи
        system_prompt: TEXT NOT NULL          # промпт
        description: TEXT                     # описание для интерфейса
        created_at: TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    """

    table_name = 'bot_profiles'

    @classmethod
    def get_by_bot_id(cls, bot_id: str) -> Optional[Dict[str, Any]]:
        """
        Получает профиль по строковому ID.

        Args:
            bot_id: Строковый ID ('oliver', 'will', ...)

        Returns:
            Optional[Dict]: Данные профиля или None
        """
        conn = get_db_connection()
        try:
            query = "SELECT * FROM bot_profiles WHERE bot_id = %s"
            profile = execute_dict_one(conn, query, (bot_id,))
            logger.debug(f"Поиск профиля '{bot_id}': {'найден' if profile else 'не найден'}")
            return profile
        finally:
            conn.close()

    @classmethod
    def get_all_enabled(cls) -> List[Dict[str, Any]]:
        """
        Получает только включённые профили (с учётом feature flags).

        Returns:
            List[Dict]: Список включённых профилей
        """
        # Получаем список ID включённых профилей
        enabled_ids = FeatureConfig.get_enabled_profiles()

        if not enabled_ids:
            logger.debug("Нет включённых профилей")
            return []

        conn = get_db_connection()
        cur = get_dict_cursor(conn)

        try:
            # Создаём плейсхолдеры для SQL IN
            placeholders = ','.join(['%s'] * len(enabled_ids))
            query = f"""
                SELECT id, bot_id, bot_name, avatar, description
                FROM bot_profiles
                WHERE bot_id IN ({placeholders})
                ORDER BY bot_name
            """
            cur.execute(query, enabled_ids)
            profiles = cur.fetchall()

            logger.debug(f"Загружено {len(profiles)} включённых профилей")
            return profiles

        finally:
            cur.close()
            conn.close()

    @classmethod
    def get_all(cls) -> List[Dict[str, Any]]:
        """
        Получает все профили (без фильтрации).

        Returns:
            List[Dict]: Все профили
        """
        conn = get_db_connection()
        cur = get_dict_cursor(conn)

        try:
            query = """
                SELECT id, bot_id, bot_name, avatar, description
                FROM bot_profiles
                ORDER BY bot_name
            """
            cur.execute(query)
            profiles = cur.fetchall()

            logger.debug(f"Загружено {len(profiles)} профилей")
            return profiles

        finally:
            cur.close()
            conn.close()

    @classmethod
    def get_with_prompt(cls, profile_id: int) -> Optional[Dict[str, Any]]:
        """
        Получает профиль с полным промптом.

        Args:
            profile_id: ID профиля

        Returns:
            Optional[Dict]: Профиль с system_prompt
        """
        return cls.get_by_id(profile_id)

    @classmethod
    def create_or_update(cls, bot_id: str, name: str, avatar: str,
                        prompt: str, description: str) -> int:
        """
        Создаёт или обновляет профиль.

        Используется при инициализации из prompts/.

        Args:
            bot_id: Строковый ID
            name: Имя бота
            avatar: Эмодзи
            prompt: Системный промпт
            description: Описание

        Returns:
            int: ID профиля
        """
        conn = get_db_connection()
        cur = conn.cursor()

        try:
            cur.execute("""
                INSERT INTO bot_profiles (bot_id, bot_name, avatar, system_prompt, description)
                VALUES (%s, %s, %s, %s, %s)
                ON CONFLICT (bot_id) DO UPDATE SET
                    bot_name = EXCLUDED.bot_name,
                    avatar = EXCLUDED.avatar,
                    system_prompt = EXCLUDED.system_prompt,
                    description = EXCLUDED.description
                RETURNING id
            """, (bot_id, name, avatar, prompt, description))

            profile_id = cur.fetchone()[0]
            conn.commit()

            logger.info(f"✅ Профиль {bot_id} (ID: {profile_id}) создан/обновлён")
            return profile_id

        except Exception as e:
            conn.rollback()
            logger.error(f"❌ Ошибка создания профиля {bot_id}: {e}")
            raise
        finally:
            cur.close()
            conn.close()

    @classmethod
    def get_id_by_bot_id(cls, bot_id: str) -> Optional[int]:
        """
        Получает числовой ID профиля по строковому ID.

        Args:
            bot_id: Строковый ID

        Returns:
            Optional[int]: Числовой ID или None
        """
        profile = cls.get_by_bot_id(bot_id)
        return profile['id'] if profile else None