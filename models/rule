#!/usr/bin/env python
# -*- coding: utf-8 -*-

"""
================================================================================
–§–ê–ô–õ: models/rule.py
–ù–ê–ó–ù–ê–ß–ï–ù–ò–ï: –ú–æ–¥–µ–ª—å –ø—Ä–∞–≤–∏–ª –ø—Ä–æ—Ñ–∏–ª—è
–ê–í–¢–û–†: Oliver Vance
–î–ê–¢–ê: 2026-02-14

–û–ü–ò–°–ê–ù–ò–ï:
    –†–∞–±–æ—Ç–∞ —Å —Ç–∞–±–ª–∏—Ü–µ–π profile_rules:
    - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª –¥–ª—è –ø—Ä–æ—Ñ–∏–ª–µ–π
    - –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª —Å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–æ–π –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É
    - –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª

–ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï:
    from models.rule import ProfileRule

    # –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ
    ProfileRule.add(profile_id=1, rule_text="–ë—É–¥—å –≤–µ–∂–ª–∏–≤", priority='‚ùó')

    # –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞ –ø—Ä–æ—Ñ–∏–ª—è
    rules = ProfileRule.get_for_profile(1)

–ò–°–¢–û–†–ò–Ø –ò–ó–ú–ï–ù–ï–ù–ò–ô:
    2026-02-14 - Oliver - —Å–æ–∑–¥–∞–Ω–∏–µ
================================================================================
"""

from typing import List, Dict, Any, Optional

from utils.db import get_db_connection, get_dict_cursor, execute_insert
from models.base import BaseModel

import logging

logger = logging.getLogger(__name__)


class ProfileRule(BaseModel):
    """
    –ú–æ–¥–µ–ª—å –ø—Ä–∞–≤–∏–ª–∞ –ø—Ä–æ—Ñ–∏–ª—è.

    –¢–∞–±–ª–∏—Ü–∞: profile_rules
    –ü–æ–ª—è:
        id: SERIAL PRIMARY KEY
        profile_id: INTEGER NOT NULL REFERENCES bot_profiles(id) ON DELETE CASCADE
        rule_text: TEXT NOT NULL
        priority: VARCHAR(10) DEFAULT '‚Ä¢' CHECK (priority IN ('‚ùó', 'üìå', '‚Ä¢'))
        created_at: TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    """

    table_name = 'profile_rules'

    # –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤
    PRIORITY_CRITICAL = '‚ùó'   # –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∞–≤–∏–ª–æ
    PRIORITY_HIGH = 'üìå'       # –≤–∞–∂–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ
    PRIORITY_NORMAL = '‚Ä¢'      # –æ–±—ã—á–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ

    @classmethod
    def add(cls, profile_id: int, rule_text: str, priority: str = PRIORITY_NORMAL) -> int:
        """
        –î–æ–±–∞–≤–ª—è–µ—Ç –ø—Ä–∞–≤–∏–ª–æ –¥–ª—è –ø—Ä–æ—Ñ–∏–ª—è.

        Args:
            profile_id: ID –ø—Ä–æ—Ñ–∏–ª—è
            rule_text: –¢–µ–∫—Å—Ç –ø—Ä–∞–≤–∏–ª–∞
            priority: –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç ('‚ùó', 'üìå', '‚Ä¢')

        Returns:
            int: ID —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ –ø—Ä–∞–≤–∏–ª–∞

        Raises:
            ValueError: –ï—Å–ª–∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º
        """
        if priority not in [cls.PRIORITY_CRITICAL, cls.PRIORITY_HIGH, cls.PRIORITY_NORMAL]:
            raise ValueError(f"–ù–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: {priority}")

        conn = get_db_connection()
        try:
            rule_id = execute_insert(conn, 'profile_rules', {
                'profile_id': profile_id,
                'rule_text': rule_text,
                'priority': priority
            })

            conn.commit()
            logger.info(f"‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ø—Ä–∞–≤–∏–ª–æ {rule_id} –¥–ª—è –ø—Ä–æ—Ñ–∏–ª—è {profile_id} (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: {priority})")
            return rule_id

        except Exception as e:
            conn.rollback()
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª–∞: {e}")
            raise
        finally:
            conn.close()

    @classmethod
    def get_for_profile(cls, profile_id: int) -> List[Dict[str, Any]]:
        """
        –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è –ø—Ä–æ—Ñ–∏–ª—è, –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É.

        Args:
            profile_id: ID –ø—Ä–æ—Ñ–∏–ª—è

        Returns:
            List[Dict]: –°–ø–∏—Å–æ–∫ –ø—Ä–∞–≤–∏–ª
        """
        conn = get_db_connection()
        cur = get_dict_cursor(conn)

        try:
            query = """
                SELECT id, rule_text, priority, created_at
                FROM profile_rules
                WHERE profile_id = %s
                ORDER BY
                    CASE priority
                        WHEN '‚ùó' THEN 1
                        WHEN 'üìå' THEN 2
                        ELSE 3
                    END,
                    created_at DESC
            """
            cur.execute(query, (profile_id,))
            rules = cur.fetchall()

            logger.debug(f"–ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(rules)} –ø—Ä–∞–≤–∏–ª –¥–ª—è –ø—Ä–æ—Ñ–∏–ª—è {profile_id}")
            return rules

        finally:
            cur.close()
            conn.close()

    @classmethod
    def delete(cls, rule_id: int) -> bool:
        """
        –£–¥–∞–ª—è–µ—Ç –ø—Ä–∞–≤–∏–ª–æ.

        Args:
            rule_id: ID –ø—Ä–∞–≤–∏–ª–∞

        Returns:
            bool: True –µ—Å–ª–∏ —É–¥–∞–ª–µ–Ω–æ
        """
        conn = get_db_connection()
        cur = conn.cursor()

        try:
            cur.execute("DELETE FROM profile_rules WHERE id = %s", (rule_id,))
            deleted = cur.rowcount > 0
            conn.commit()

            if deleted:
                logger.info(f"‚úÖ –£–¥–∞–ª–µ–Ω–æ –ø—Ä–∞–≤–∏–ª–æ {rule_id}")
            else:
                logger.warning(f"‚ö†Ô∏è –ü—Ä–∞–≤–∏–ª–æ {rule_id} –Ω–µ –Ω–∞–π–¥–µ–Ω–æ")

            return deleted

        except Exception as e:
            conn.rollback()
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª–∞ {rule_id}: {e}")
            return False
        finally:
            cur.close()
            conn.close()

    @classmethod
    def delete_for_profile(cls, profile_id: int) -> int:
        """
        –£–¥–∞–ª—è–µ—Ç –≤—Å–µ –ø—Ä–∞–≤–∏–ª–∞ –ø—Ä–æ—Ñ–∏–ª—è.

        Args:
            profile_id: ID –ø—Ä–æ—Ñ–∏–ª—è

        Returns:
            int: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–¥–∞–ª—ë–Ω–Ω—ã—Ö –ø—Ä–∞–≤–∏–ª
        """
        conn = get_db_connection()
        cur = conn.cursor()

        try:
            cur.execute("DELETE FROM profile_rules WHERE profile_id = %s", (profile_id,))
            deleted = cur.rowcount
            conn.commit()

            logger.info(f"‚úÖ –£–¥–∞–ª–µ–Ω–æ {deleted} –ø—Ä–∞–≤–∏–ª –¥–ª—è –ø—Ä–æ—Ñ–∏–ª—è {profile_id}")
            return deleted

        except Exception as e:
            conn.rollback()
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª –ø—Ä–æ—Ñ–∏–ª—è {profile_id}: {e}")
            return 0
        finally:
            cur.close()
            conn.close()

    @classmethod
    def format_for_prompt(cls, profile_id: int) -> str:
        """
        –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç.

        Args:
            profile_id: ID –ø—Ä–æ—Ñ–∏–ª—è

        Returns:
            str: –¢–µ–∫—Å—Ç –ø—Ä–∞–≤–∏–ª –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ –≤ –ø—Ä–æ–º–ø—Ç
        """
        rules = cls.get_for_profile(profile_id)

        if not rules:
            return ""

        formatted = "\n\n–í–ê–ñ–ù–´–ï –ü–†–ê–í–ò–õ–ê –î–õ–Ø –≠–¢–û–ì–û –ß–ê–¢–ê:\n"
        for rule in rules:
            formatted += f"{rule['priority']} {rule['rule_text']}\n"

        return formatted

    @classmethod
    def count_for_profile(cls, profile_id: int) -> int:
        """
        –°—á–∏—Ç–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–∞–≤–∏–ª —É –ø—Ä–æ—Ñ–∏–ª—è.

        Args:
            profile_id: ID –ø—Ä–æ—Ñ–∏–ª—è

        Returns:
            int: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–∞–≤–∏–ª
        """
        conn = get_db_connection()
        cur = conn.cursor()

        try:
            cur.execute("SELECT COUNT(*) FROM profile_rules WHERE profile_id = %s", (profile_id,))
            count = cur.fetchone()[0]
            return count

        finally:
            cur.close()
            conn.close()