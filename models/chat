#!/usr/bin/env python
# -*- coding: utf-8 -*-

"""
================================================================================
–§–ê–ô–õ: models/chat.py
–ù–ê–ó–ù–ê–ß–ï–ù–ò–ï: –ú–æ–¥–µ–ª—å —á–∞—Ç–∞
–ê–í–¢–û–†: Oliver Vance
–î–ê–¢–ê: 2026-02-14

–û–ü–ò–°–ê–ù–ò–ï:
    –†–∞–±–æ—Ç–∞ —Å —Ç–∞–±–ª–∏—Ü–µ–π chats:
    - –°–æ–∑–¥–∞–Ω–∏–µ —á–∞—Ç–∞
    - –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    - –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ
    - –£–¥–∞–ª–µ–Ω–∏–µ
    - –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–ª–∞–¥–µ–ª—å—Ü–∞

–ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï:
    from models.chat import Chat

    # –°–æ–∑–¥–∞—Ç—å —á–∞—Ç
    chat_id = Chat.create(user_id=1, title="–ú–æ–π —á–∞—Ç")

    # –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ —á–∞—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    chats = Chat.get_user_chats(1)

–ò–°–¢–û–†–ò–Ø –ò–ó–ú–ï–ù–ï–ù–ò–ô:
    2026-02-14 - Oliver - —Å–æ–∑–¥–∞–Ω–∏–µ
================================================================================
"""

from typing import List, Dict, Any, Optional
from datetime import datetime

from utils.db import get_db_connection, get_dict_cursor, execute_insert, execute_dict_one
from models.base import BaseModel

import logging

logger = logging.getLogger(__name__)


class Chat(BaseModel):
    """
    –ú–æ–¥–µ–ª—å —á–∞—Ç–∞.

    –¢–∞–±–ª–∏—Ü–∞: chats
    –ü–æ–ª—è:
        id: SERIAL PRIMARY KEY
        user_id: INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE
        title: VARCHAR(200) NOT NULL
        bot_profile_id: INTEGER REFERENCES bot_profiles(id)
        created_at: TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        updated_at: TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    """

    table_name = 'chats'

    @classmethod
    def create(cls, user_id: int, title: str, bot_profile_id: Optional[int] = None) -> int:
        """
        –°–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–π —á–∞—Ç.

        Args:
            user_id: ID –≤–ª–∞–¥–µ–ª—å—Ü–∞ —á–∞—Ç–∞
            title: –ù–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞
            bot_profile_id: ID –ø—Ä–æ—Ñ–∏–ª—è –±–æ—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

        Returns:
            int: ID —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ —á–∞—Ç–∞
        """
        conn = get_db_connection()
        try:
            chat_id = execute_insert(conn, 'chats', {
                'user_id': user_id,
                'title': title,
                'bot_profile_id': bot_profile_id
            })

            conn.commit()
            logger.info(f"‚úÖ –°–æ–∑–¥–∞–Ω —á–∞—Ç {chat_id} –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
            return chat_id

        except Exception as e:
            conn.rollback()
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —á–∞—Ç–∞: {e}")
            raise
        finally:
            conn.close()

    @classmethod
    def get_user_chats(cls, user_id: int) -> List[Dict[str, Any]]:
        """
        –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ —á–∞—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø–æ—Å–ª–µ–¥–Ω–µ–º —Å–æ–æ–±—â–µ–Ω–∏–∏.

        Args:
            user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

        Returns:
            List[Dict]: –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤
        """
        conn = get_db_connection()
        cur = get_dict_cursor(conn)

        try:
            query = """
                SELECT
                    c.id,
                    c.title,
                    COALESCE(bp.avatar, 'üí¨') as avatar,
                    COALESCE(
                        (SELECT created_at FROM messages WHERE chat_id = c.id ORDER BY created_at DESC LIMIT 1),
                        c.created_at
                    ) as last_message_at
                FROM chats c
                LEFT JOIN bot_profiles bp ON c.bot_profile_id = bp.id
                WHERE c.user_id = %s
                ORDER BY c.updated_at DESC
            """
            cur.execute(query, (user_id,))
            chats = cur.fetchall()

            logger.debug(f"–ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(chats)} —á–∞—Ç–æ–≤ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
            return chats

        finally:
            cur.close()
            conn.close()

    @classmethod
    def rename(cls, chat_id: int, new_title: str) -> bool:
        """
        –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ—Ç —á–∞—Ç.

        Args:
            chat_id: ID —á–∞—Ç–∞
            new_title: –ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ

        Returns:
            bool: True –µ—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ
        """
        conn = get_db_connection()
        cur = conn.cursor()

        try:
            cur.execute("""
                UPDATE chats
                SET title = %s, updated_at = CURRENT_TIMESTAMP
                WHERE id = %s
            """, (new_title, chat_id))

            updated = cur.rowcount > 0
            conn.commit()

            if updated:
                logger.info(f"‚úÖ –ß–∞—Ç {chat_id} –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω –≤ '{new_title}'")
            else:
                logger.warning(f"‚ö†Ô∏è –ß–∞—Ç {chat_id} –Ω–µ –Ω–∞–π–¥–µ–Ω")

            return updated

        except Exception as e:
            conn.rollback()
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è —á–∞—Ç–∞ {chat_id}: {e}")
            return False
        finally:
            cur.close()
            conn.close()

    @classmethod
    def delete(cls, chat_id: int) -> bool:
        """
        –£–¥–∞–ª—è–µ—Ç —á–∞—Ç –∏ –≤—Å–µ –µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è.

        Args:
            chat_id: ID —á–∞—Ç–∞

        Returns:
            bool: True –µ—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ
        """
        conn = get_db_connection()
        cur = conn.cursor()

        try:
            # –°–Ω–∞—á–∞–ª–∞ —É–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è (–∫–∞—Å–∫–∞–¥–Ω–æ, –Ω–æ –¥–ª—è –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏)
            cur.execute("DELETE FROM messages WHERE chat_id = %s", (chat_id,))
            deleted_messages = cur.rowcount

            # –ó–∞—Ç–µ–º —É–¥–∞–ª—è–µ–º —Å–∞–º —á–∞—Ç
            cur.execute("DELETE FROM chats WHERE id = %s", (chat_id,))
            deleted = cur.rowcount > 0

            conn.commit()

            if deleted:
                logger.info(f"‚úÖ –£–¥–∞–ª—ë–Ω —á–∞—Ç {chat_id} –∏ {deleted_messages} —Å–æ–æ–±—â–µ–Ω–∏–π")
            else:
                logger.warning(f"‚ö†Ô∏è –ß–∞—Ç {chat_id} –Ω–µ –Ω–∞–π–¥–µ–Ω")

            return deleted

        except Exception as e:
            conn.rollback()
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —á–∞—Ç–∞ {chat_id}: {e}")
            return False
        finally:
            cur.close()
            conn.close()

    @classmethod
    def get_by_id(cls, chat_id: int) -> Optional[Dict[str, Any]]:
        """
        –ü–æ–ª—É—á–∞–µ—Ç —á–∞—Ç –ø–æ ID —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø—Ä–æ—Ñ–∏–ª–µ.

        Args:
            chat_id: ID —á–∞—Ç–∞

        Returns:
            Optional[Dict]: –î–∞–Ω–Ω—ã–µ —á–∞—Ç–∞
        """
        conn = get_db_connection()
        cur = get_dict_cursor(conn)

        try:
            query = """
                SELECT
                    c.*,
                    bp.system_prompt,
                    bp.bot_name,
                    bp.avatar,
                    bp.description as profile_description
                FROM chats c
                LEFT JOIN bot_profiles bp ON c.bot_profile_id = bp.id
                WHERE c.id = %s
            """
            cur.execute(query, (chat_id,))
            chat = cur.fetchone()

            logger.debug(f"–ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–∞ {chat_id}: {'–Ω–∞–π–¥–µ–Ω' if chat else '–Ω–µ –Ω–∞–π–¥–µ–Ω'}")
            return chat

        finally:
            cur.close()
            conn.close()

    @classmethod
    def is_owner(cls, chat_id: int, user_id: int) -> bool:
        """
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–ª–∞–¥–µ–ª—å—Ü–µ–º —á–∞—Ç–∞.

        Args:
            chat_id: ID —á–∞—Ç–∞
            user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

        Returns:
            bool: True –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - –≤–ª–∞–¥–µ–ª–µ—Ü
        """
        chat = cls.get_by_id(chat_id)
        return chat is not None and chat['user_id'] == user_id

    @classmethod
    def update_timestamp(cls, chat_id: int) -> bool:
        """
        –û–±–Ω–æ–≤–ª—è–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω—É—é –º–µ—Ç–∫—É —á–∞—Ç–∞ (–ø—Ä–∏ –Ω–æ–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏).

        Args:
            chat_id: ID —á–∞—Ç–∞

        Returns:
            bool: True –µ—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ
        """
        conn = get_db_connection()
        cur = conn.cursor()

        try:
            cur.execute("""
                UPDATE chats
                SET updated_at = CURRENT_TIMESTAMP
                WHERE id = %s
            """, (chat_id,))

            conn.commit()
            return True

        except Exception as e:
            conn.rollback()
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è timestamp —á–∞—Ç–∞ {chat_id}: {e}")
            return False
        finally:
            cur.close()
            conn.close()